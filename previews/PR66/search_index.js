var documenterSearchIndex = {"docs":
[{"location":"references/#References","page":"References","title":"References","text":"Howard,¬†L.¬†N. (1961). Note on a paper of John W. Miles. Journal¬†of¬†Fluid¬†Mechanics 10, 509‚Äì512.\n\n\n\nKhairoutdinov,¬†M.¬†F.; Blossey,¬†P.¬†N. and Bretherton,¬†C.¬†S. (2022). Global system for atmospheric modeling: Model description and preliminary results. Journal¬†of¬†Advances¬†in¬†Modeling¬†Earth¬†Systems 14, e2021MS002968.\n\n\n\nMiles,¬†J.¬†W. (1961). On the stability of heterogeneous shear flows. Journal¬†of¬†Fluid¬†Mechanics 10, 496‚Äì508.\n\n\n\nPauluis,¬†O. (2008). Thermodynamic consistency of the anelastic approximation for a moist atmosphere. Journal¬†of¬†the¬†Atmospheric¬†Sciences 65, 2719‚Äì2729.\n\n\n\nPressel,¬†K.¬†G.; Kaul,¬†C.¬†M.; Schneider,¬†T.; Tan,¬†Z. and Mishra,¬†S. (2015). Large-eddy simulation in an anelastic framework with closed water and entropy balances. Journal¬†of¬†Advances¬†in¬†Modeling¬†Earth¬†Systems 7, 1425‚Äì1456.\n\n\n\nStraka,¬†J.¬†M. (2009). Cloud and precipitation microphysics: Principles and parameterizations (Cambridge University Press).\n\n\n\n","category":"section"},{"location":"contributing/#Contributors-guide","page":"Contributors guide","title":"Contributors guide","text":"","category":"section"},{"location":"contributing/#Developing-Breeze.jl-locally","page":"Contributors guide","title":"Developing Breeze.jl locally","text":"To develop Breeze.jl locally, git clone the repo:\n\ngit clone https://github.com/NumericalEarth/Breeze.jl","category":"section"},{"location":"contributing/#running-tests","page":"Contributors guide","title":"Running the tests","text":"After entering the top-level directory of your local clone of Breeze.jl (cd Breeze.jl), start Julia with\n\njulia --project=.\n\nto activate the environment of the package. Then, in an interactive Julia REPL you just started, you can run the tests by typing ] to enter the Pkg mode and then run\n\ntest Breeze\n\nor, in the normal REPL mode (not Pkg) run the commands\n\nimport Pkg\nPkg.test(\"Breeze\")\n\nBreeze.jl uses ParallelTestRunner.jl for distributing the tests and running them in parallel. Read the documentation of ParallelTestRunner.jl for more information about it, but interesting arguments are\n\n--jobs N to use N jobs for running the tests\n--verbose to print more information while the tests are running (e.g. when a test job starts, duration of each job, etc.)\nthe list of tests to run, excluding all others, this can be useful for quickly running only a subset of the whole tests.\n\nYou can pass the arguments with the test_args keyword argument to Pkg.test, for example\n\nimport Pkg\nPkg.test(\"Breeze\"; test_args=`--verbose --jobs 2 moist_air atmosphere`)\n\nSimilarly, to run only the doctests, you can use the command\n\nimport Pkg\nPkg.test(\"Breeze\"; test_args=`doctests`)\n\nnote: List of tests\nThe names of the test jobs are the file names under the test directory, without the .jl extension, excluding the runtests.jl file. Filtering test names is done by matching the provided arguments with startswith, so you can use the first few letters of the test names. Be sure not to catch also other tests you want to skip. To see the full list of available tests you can use the --list option:import Pkg\nPkg.test(\"Breeze\"; test_args=`--list`)","category":"section"},{"location":"contributing/#GPU-tests","page":"Contributors guide","title":"GPU tests","text":"When running the tests, if a CUDA GPU is detected, they automatically use the GPU Oceananigans architecture, otherwise they run on CPU. To temporarily disable the automatic detection of the GPU and forcibly run the tests on CPU you can set the environment variable CUDA_VISIBLE_DEVICES=-1. For example, from within a Julia session you can do\n\nENV[\"CUDA_VISIBLE_DEVICES\"] = \"-1\"\nimport Pkg\nPkg.test(\"Breeze\")\n\nnote: Contributing new tests\nWhen contributing new tests to Breeze.jl, make sure to pass to the grid the global variable default_arch, defined in the init code of all tests, unless you specifically want to use a different architecture.","category":"section"},{"location":"contributing/#Coding-style","page":"Contributors guide","title":"Coding style","text":"","category":"section"},{"location":"contributing/#Explicitly-imported-packages","page":"Contributors guide","title":"Explicitly imported packages","text":"The Breeze.jl community doesn't currently enforce a strict coding style, but it uses the package ExplicitImports.jl to ensure consistency of loaded modules and accessed functions and variables. This is checked during the tests, so you may get test failures if you don't follow the prescribed package importing style, the test error message will contain information to suggest you how to fix the issues, read it carefully. See ExplicitImports.jl documentation for the motivation of this style.","category":"section"},{"location":"contributing/#Building-the-documentation-locally","page":"Contributors guide","title":"Building the documentation locally","text":"Breeze.jl documentation is generated using Documenter.jl. You can preview how the documentation will look like with your changes by building the documentation locally.  From the top-level directory of your local repository run\n\njulia --project=docs/ -e 'using Pkg; Pkg.instantiate()'\n\nto instantiate the documentation environment and then\n\njulia --project=docs/ docs/make.jl\n\nto build the documentation. If you want to quickly build a draft copy of the documentation (i.e. without running all the examples or running the doctests), modify the call to the makedocs function in docs/make.jl to set the keyword argument draft=true and run again the docs/make.jl script. When you submit a pull request to Breeze.jl, if the documentation building job is successfull a copy of the build will be uploaded as an artifact, which you can retrieve by looking at the summary page of the documentation job.\n\nTo view the documentation you can open the generated HTML files in the docs/build directory, but you need an HTTP server to be able to move around the website and follow internal links. The LiveServer package provides a simple HTTP server implementation, which also automatically reloads the pages when they are modified on disk:\n\nimport Pkg\nPkg.activate(\"live-server\"; shared=true)\nPkg.add(\"LiveServer\") # this is necessary only the first time, to install LiveServer\nusing LiveSever: serve\nserve(; dir=\"docs/build\")","category":"section"},{"location":"thermodynamics/#Thermodynamics-section","page":"Thermodynamics","title":"Atmosphere Thermodynamics","text":"Breeze implements thermodynamic relations for moist atmospheres. By \"moist\", we mean that the atmosphere is a mixture of four components: two gas phases (i) \"dry\" air and (ii) \"vapor\", and two \"condensed\" phases (iii) \"liquid\", and (iv) \"ice\". Moisture makes life interesting, because vapor can condense or solidify (and liquid can freeze) into liquid droplets and ice particles - with major consequences.\n\nOn Earth, dry air is itself a mixture of gases with fixed composition constant molar mass. Dry air on Earth's is mostly nitrogen, oxygen, and argon, whose combination produces the typical (and Breeze's default) dry air molar mass\n\nusing Breeze\nthermo = ThermodynamicConstants()\nthermo.dry_air.molar_mass\n\nThe vapor, liquid, and ice components are mathrmH_2 O, also known as \"water\". Water vapor, which in Breeze has the default molar mass\n\nthermo.vapor.molar_mass\n\nis lighter than dry air. As a result, moist, humid air is lighter than dry air.\n\nLiquid in Earth's atmosphere consists of falling droplets that range from tiny, nearly-suspended mist particles to careening fat rain drops. Ice in Earth's atmosphere consists of crystals, graupel, sleet, hail and, snow.","category":"section"},{"location":"thermodynamics/#\"Moist\"-thermodynamic-relations-for-a-four-component-mixture","page":"Thermodynamics","title":"\"Moist\" thermodynamic relations for a four-component mixture","text":"What does it mean that moist air is a mixture of four components? It means that the total mass mathcalM of air per volume, or density, œÅ, can be expressed as the sum of the masses of the individual components over the total volume V,\n\nœÅ = fracmathcalMV = fracmathcalM·µà + mathcalM·µõ + mathcalMÀ° + mathcalM‚Å±V = œÅ·µà + œÅ·µõ + œÅÀ° + œÅ‚Å±\n\nwhere mathcalM·µà, mathcalM·µõ, mathcalMÀ°, and mathcalM‚Å± are the masses of dry air, vapor, liquid, and ice, respectively, while œÅ·µà, œÅ·µõ, œÅÀ°, and œÅ‚Å± denote their fractional densities. We likewise define the mass fractions of each component,\n\nq·µà  fracmathcalM·µàmathcalM = fracœÅ·µàœÅ  qquad q·µõ  fracmathcalM·µõmathcalM = fracœÅ·µõœÅ  qquad\nqÀ°  fracmathcalMÀ°mathcalM = fracœÅÀ°œÅ qquad textand qquad q‚Å±  fracœÅ‚Å±œÅ = fracmathcalM‚Å±mathcalM \n\nnote: The significance of certain superscripts\nThroughout this documentation, superscripts are used to distinguish the components of moist air:d denotes \"dry air\"\nv denotes \"vapor\"\nl denotes \"liquid\"\ni denotes \"ice\"A fifth super script t is used to denote \"total\". For example, q·µà is the mass fraction of dry air, q·µõ is the mass fraction of vapor, qÀ° is the mass fraction of liquid, q‚Å± is the mass fraction of ice, andq·µó = q·µõ + qÀ° + q‚Å±is the \"total\" mass fraction of the moisture components.\n\nThe liquid and ice components are not always present. For example, a model with warm-phase microphysics does not have ice. With no microphysics at all, there is no liquid or ice.\n\nBy definition, all of the mass fractions sum up to unity,\n\n1 = q·µà + q·µõ + qÀ° + q‚Å± \n\nso that, using q·µó = q·µõ + qÀ° + q‚Å±, the dry air mass fraction can be diagnosed with q·µà = 1 - q·µó. The sometimes tedious bookkeeping required to correctly diagnose the effective mixture properties of moist air are facilitated by Breeze's handy MoistureMassFractions abstraction. For example,\n\nq = Breeze.Thermodynamics.MoistureMassFractions(0.01, 0.002, 1e-5)\n\nfrom which we can compute the total moisture mass fraction,\n\nq·µó = Breeze.Thermodynamics.total_specific_moisture(q)\n\nAnd the dry as well,\n\nq·µà = Breeze.Thermodynamics.dry_air_mass_fraction(q)\n\nTo be sure,\n\nq·µà + q·µó","category":"section"},{"location":"thermodynamics/#Two-laws-for-ideal-gases","page":"Thermodynamics","title":"Two laws for ideal gases","text":"Both dry air and vapor are modeled as ideal gases, which means that the ideal gas law relates pressure p, temperature T, and density œÅ,\n\np = œÅ R T \n\nAbove, R  ‚Ñõ  m is the specific gas constant given the molar or \"universal\" gas constant ‚Ñõ  831  mathrmJ  mathrmK^-1  mathrmmol^-1 and molar mass m of the gas species under consideration.\n\nThe first law of thermodynamics, aka \"conservation of energy\", states that infinitesimal changes in \"heat content\"[1] mathrmd mathcalH are related to infinitesimal changes in temperature mathrmd T and pressure mathrmd p according to:[2]\n\nmathrmd mathcalH = c·µñ mathrmd T - fracmathrmd pœÅ \n\n[1]: mathcalH is called enthalpy\n\n[2]: The conservation of energy states that any external heat input into the gas must equal the sum   of the change of the gas's internal energy and the work done by the gas, p  mathrmd V.   For atmospheric flows it's convenient to express everything per unit mass. Assuming the mass of   the fluid is conserved, we have that the work done per unit mass is p  mathrmd(rho^-1)   and the internal energy per unit mass is mathcalI  c·µõ mathrmd T.   Therefore, if mathrmd mathcalH is the change in heat content per unit mass,   we have:mathrmd mathcalH = c·µõ mathrmd T + p  mathrmd(œÅ^-1) By utilizing the identity mathrmd(p  œÅ) = p  mathrmd(œÅ^-1) + œÅ^-1 mathrmdp and using the ideal gas, we can rewrite the above conservation law as:mathrmd mathcalH = (c·µõ + R) mathrmd T - œÅ^-1 mathrmdp which is the expression in the main text after noting that the specific heat capacities under constant pressure and under constant volume are related via c·µñ  c·µõ + R.\n\nwhere c·µñ is the specific heat capacity at constant pressure of the gas in question.\n\nFor example, to represent dry air typical for Earth, with molar mass m = 0029  mathrmkg  mathrmmol^-1 and constant-pressure heat capacity c^p = 1005  mathrmJ  mathrmkg^-1  mathrmK^-1, we write\n\nusing Breeze.Thermodynamics: IdealGas\ndry_air = IdealGas(molar_mass=0.029, heat_capacity=1005)\n\nWe can also change the properties of dry air by specifying new values when constructing ThermodynamicConstants,\n\nweird_thermo = ThermodynamicConstants(dry_air_molar_mass=0.042, dry_air_heat_capacity=420)\nweird_thermo.dry_air","category":"section"},{"location":"thermodynamics/#Potential-temperature-and-\"adiabatic\"-transformations","page":"Thermodynamics","title":"Potential temperature and \"adiabatic\" transformations","text":"Within adiabatic transformations, mathrmd mathcalH = 0. Then, combining the ideal gas law with conservation of energy yields\n\nfracmathrmd TT = fracRc·µñ fracmathrmd pp \n\nwhich implies that T  ( p  p‚ÇÄ )^R  c·µñ, where p‚ÇÄ is some reference pressure value.\n\nAs a result, the potential temperature, Œ∏, defined as\n\nŒ∏  T big  left ( fracpp‚ÇÄ right )^R  c·µñ = fracTŒ† \n\nremains constant under adiabatic transformations. Notice that above, we also defined the Exner function, Œ†  ( p  p‚ÇÄ )^R  c·µñ.\n\nnote: About subscripts\nThe subscript \"0\" typically indicates some quantity evaluated at the surface z=0. By convention, we tend to invoke constants that represent profiles evaluated at z=0: i.e., p‚ÇÄ = p(z=0), T‚ÇÄ = T(z=0), etc. This implies that the potential temperature under adiabatic transformation is Œ∏(z) = Œ∏‚ÇÄ = T‚ÇÄ.","category":"section"},{"location":"thermodynamics/#Hydrostatic-balance","page":"Thermodynamics","title":"Hydrostatic balance","text":"Next we consider a reference state that does not exchange energy with its environment (i.e., mathrmd mathcalH = 0) and thus has constant potential temperature\n\nŒ∏‚ÇÄ = T·µ£ left ( fracp‚ÇÄp·µ£ right )^R  c·µñ \n\nnote: Reference states\nSubscripts r indicate a reference state. The adiabatic, hydrostatically-balanced reference state in the process of elucidation presently has a z dependent reference pressure p·µ£(z), density œÅ·µ£(z), and temperature T·µ£(z). This reference state also has a constant potential temperature Œ∏‚ÇÄ, which we attempt to clarify by writing Œ∏‚ÇÄ (since it's constant, it has the same value at z=0 as at any height). We apologize that our notation differs from the usual in which 0 subscripts indicate \"reference\" (ü§î) and 00 (ü´£) means z=0.\n\nHydrostatic balance requires\n\n_z p·µ£ = - œÅ·µ£ g \n\nwhere g is gravitational acceleration, naturally by default\n\nthermo.gravitational_acceleration\n\nBy combining the hydrostatic balance with the ideal gas law and the definition of potential temperature we get\n\nfracp·µ£p‚ÇÄ = left (1 - fracg zc·µñ Œ∏‚ÇÄ right )^c·µñ  R \n\nThus\n\nbeginalign*\nT·µ£(z)  = Œ∏‚ÇÄ left ( fracp·µ£p‚ÇÄ right )^R  c·µñ \n       = Œ∏‚ÇÄ - fracgc·µñ z\nendalign*\n\nand\n\nœÅ·µ£(z) = fracp‚ÇÄR·µà Œ∏‚ÇÄ left ( 1 - fracg zc·µñ Œ∏‚ÇÄ right )^c·µñ  R - 1 \n\nThe quantity g  c·µñ  976 mathrmKmathrmkm^-1 that appears above is also referred to as the \"dry adiabatic lapse rate\".","category":"section"},{"location":"thermodynamics/#An-example-of-a-dry-reference-state-in-Breeze","page":"Thermodynamics","title":"An example of a dry reference state in Breeze","text":"We can visualise a hydrostatic reference profile evaluating Breeze's reference-state utilities (which assume a dry reference state) on a one-dimensional RectilinearGrid. In the following code, the superscript d denotes dry air, e.g., an ideal gas with R·µà = 28671  mathrmJ  mathrmK^-1:\n\nusing Breeze\nusing CairoMakie\n\ngrid = RectilinearGrid(size=160, z=(0, 12_000), topology=(Flat, Flat, Bounded))\nthermo = ThermodynamicConstants()\nreference_state = ReferenceState(grid, thermo, base_pressure=101325, potential_temperature=288)\n\np·µ£ = reference_state.pressure\nœÅ·µ£ = reference_state.density\n\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\nc·µñ·µà = thermo.dry_air.heat_capacity\np‚ÇÄ = reference_state.base_pressure\nŒ∏‚ÇÄ = reference_state.potential_temperature\ng = thermo.gravitational_acceleration\n\n# Verify that T·µ£ = Œ∏‚ÇÄ - (g / c·µñ·µà) * z\nz = KernelFunctionOperation{Center, Center, Center}(znode, grid, Center(), Center(), Center())\nT·µ£‚ÇÅ = Field(Œ∏‚ÇÄ * (p·µ£ / p‚ÇÄ)^(R·µà / c·µñ·µà))\nT·µ£‚ÇÇ = Field(Œ∏‚ÇÄ - (g / c·µñ·µà) * z)\n\nfig = Figure()\n\naxT = Axis(fig[1, 1]; xlabel = \"Temperature (·µíK)\", ylabel = \"Height (m)\")\nlines!(axT, T·µ£‚ÇÅ)\nlines!(axT, T·µ£‚ÇÇ, linestyle = :dash, color = :orange, linewidth = 2)\n\naxp = Axis(fig[1, 2]; xlabel = \"Pressure (10‚Åµ Pa)\", yticklabelsvisible = false)\nlines!(axp, p·µ£ / 1e5)\n\naxœÅ = Axis(fig[1, 3]; xlabel = \"Density (kg m‚Åª¬≥)\", yticklabelsvisible = false)\nlines!(axœÅ, œÅ·µ£)\n\nfig","category":"section"},{"location":"thermodynamics/#The-gaseous-nature-of-moist-air","page":"Thermodynamics","title":"The gaseous nature of moist air","text":"To define the gaseous nature of moist air - that is, the equation of state relating density and pressure, we assume that the volume of liquid and ice components are negligible. As a result, moist air pressure is the sum of partial pressures of vapor and dry air with no contribution from liquid or ice phases,\n\np = p·µà + p·µõ \n\nBecause the dry air and vapor components are ideal gases, their densities are related to pressure through the ideal gas law,\n\np·µà = œÅ·µà R·µà T qquad textand qquad p·µõ = œÅ·µõ R·µõ T \n\nwhere T is temperature, R‚Å± = ‚Ñõ  m^Œ≤ is the specific gas constant for component Œ≤, m^Œ≤ is the molar mass of component Œ≤, and ‚Ñõ  is the molar or \"universal\" gas constant,\n\nthermo = ThermodynamicConstants()\nthermo.molar_gas_constant\n\nThermodynamicConstants, which is central to Breeze's implementation of moist thermodynamics. holds constants like the molar gas constant and molar masses, latent heats, gravitational acceleration, and more,\n\nthermo\n\nThese default values evince basic facts about water vapor air typical to Earth's atmosphere: for example, the molar masses of dry air (itself a mixture of mostly nitrogen, oxygen, and argon), and water vapor are m·µà = 0029  mathrmkg  mathrmmol^-1 and m·µõ = 0018  mathrmkg  mathrmmol^-1. And even more interesting, the triple point temperature and pressure of water vapor are\n\nthermo.triple_point_temperature, thermo.triple_point_pressure\n\nnot so far from the typical conditions we experience on Earth's surface - one of the reasons that things are so interesting down here. Also, that temperature is not a typo: the triple point temperature really is just +001^circC.\n\nIt's then convenient to introduce the \"mixture\" gas constant R·µê(q·µõ) such that\n\np = œÅ R·µê T qquad textwhere qquad R·µê  q·µà R·µà + q·µõ R·µõ \n\nTo illustrate, let's compute the mixture gas constant R·µê for air with a small amount of water vapor. The contribution of vapor increases R·µê above the dry air value:\n\nq = Breeze.Thermodynamics.MoistureMassFractions(0.01, 0.0, 0.0) # 1% vapor by mass\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\nR·µê = Breeze.Thermodynamics.mixture_gas_constant(q, thermo)\nR·µê - R·µà # shows the uplift from the vapor component\n\nA small increase in specific humidity increases the effective gas constant of air.","category":"section"},{"location":"thermodynamics/#The-thermal-properties-of-moist-air","page":"Thermodynamics","title":"The thermal properties of moist air","text":"Though we neglect the volume of liquid and ice, we do not neglect their mass or energy. The heat capacity of moist air thus includes contributions from all four components,\n\nc·µñ·µê = q·µà c·µñ·µà + q·µõ c·µñ·µõ + qÀ° cÀ° + q‚Å± c‚Å±\n\nwhere the c·µñ·µù denote the specific heat capacity at constant pressure of constituent Œ≤, and we have neglected the superscript p for liquid and ice because they are assumed incompressible (their specific heats and constant pressure or volume are the same). We call c·µñ·µê the \"mixture heat capacity\", and because with default parameters the heat capacity of dry air is the smallest of either vapor, liquid, or ice, any moisture at all tends to increase the mixture heat capacity,\n\nq = Breeze.Thermodynamics.MoistureMassFractions(0.01, 0.0, 0.0)\nc·µñ·µà = thermo.dry_air.heat_capacity\nc·µñ·µê = Breeze.Thermodynamics.mixture_heat_capacity(q, thermo)\nc·µñ·µê - c·µñ·µà","category":"section"},{"location":"thermodynamics/#The-Clausius‚ÄìClapeyron-relation-and-saturation-vapor-pressure","page":"Thermodynamics","title":"The Clausius‚ÄìClapeyron relation and saturation vapor pressure","text":"The Clausius‚ÄìClapeyron relation for an ideal gas describes how saturation vapor pressure changes with temperature:\n\nfracmathrmd p·µõmathrmd T = fracp·µõ ‚Ñí^Œ≤(T)R·µõ T^2 \n\nwhere p·µõ is saturation vapor pressure over a surface of condensed phase Œ≤, T is temperature, R·µõ is the specific gas constant for vapor, and ‚Ñí^Œ≤(T) is the latent heat of the phase transition from vapor to phase Œ≤. For atmospheric moist air, the relevant condensed phases are liquid water (Œ≤ = l) and ice (Œ≤ = i).","category":"section"},{"location":"thermodynamics/#Temperature-dependent-latent-heat","page":"Thermodynamics","title":"Temperature-dependent latent heat","text":"For a thermodynamic formulation that uses constant (i.e. temperature-independent) specific heats, the latent heat of a phase transition is linear in temperature:\n\n‚Ñí^Œ≤(T) = ‚Ñí^Œ≤_0 + Delta c^Œ≤  T \n\nwhere ‚Ñí^Œ≤_0  ‚Ñí^Œ≤(T=0) is the latent heat at absolute zero and Delta c^Œ≤  c_p^v - c^Œ≤ is the constant difference between the vapor specific heat capacity at constant pressure and the specific heat capacity of the condensed phase Œ≤.\n\nNote that we typically parameterize the latent heat in terms of a reference temperature T_r that is well above absolute zero. In that case, the latent heat is written\n\n‚Ñí^Œ≤(T) = ‚Ñí^Œ≤_r + Delta c^Œ≤ (T - T_r) qquad textand qquad\n‚Ñí^Œ≤_0 = ‚Ñí^Œ≤_r - Delta c^Œ≤ T_r \n\nwhere ‚Ñí^Œ≤_r is the latent heat at the reference temperature T_r.","category":"section"},{"location":"thermodynamics/#Integration-of-the-Clausius-Clapeyron-relation","page":"Thermodynamics","title":"Integration of the Clausius-Clapeyron relation","text":"To find the saturation vapor pressure as a function of temperature, we integrate the Clausius-Clapeyron relation with the temperature-linear latent heat model from the triple point pressure and temperature (p^tr T^tr) to a generic pressure p·µõ and temperature T:\n\nint_p^tr^p·µõ fracmathrmd pp = int_T^tr^T frac‚Ñí^Œ≤_0 + Delta c^Œ≤ TR·µõ T^2  mathrmd T \n\nEvaluating the integrals yields\n\nlogleft(fracp·µõp^trright) = -frac‚Ñí^Œ≤_0R·µõ T + frac‚Ñí^Œ≤_0R·µõ T^tr + fracDelta c^Œ≤R·µõ logleft(fracTT^trright) \n\nExponentiating both sides gives the closed-form solution:\n\np·µõ(T) = p^tr left ( fracTT^tr right )^Delta c^Œ≤  R·µõ exp left  frac‚Ñí^Œ≤_0R·µõ left (frac1T^tr - frac1T right ) right  ","category":"section"},{"location":"thermodynamics/#Example:-liquid-water-and-ice-parameters","page":"Thermodynamics","title":"Example: liquid water and ice parameters","text":"Consider parameters for liquid water,\n\nusing Breeze.Thermodynamics: CondensedPhase\nliquid_water = CondensedPhase(reference_latent_heat=2500800, heat_capacity=4181)\n\nand water ice,\n\nwater_ice = CondensedPhase(reference_latent_heat=2834000, heat_capacity=2108)\n\nThese represent the latent heat of vaporization at the reference temperature and the specific heat capacity of each condensed phase. We can compute the specific heat difference Delta c^Œ≤ for liquid water:\n\nusing Breeze.Thermodynamics: vapor_gas_constant\nc·µñ·µõ = thermo.vapor.heat_capacity\ncÀ° = thermo.liquid.heat_capacity\nŒîcÀ° = c·µñ·µõ - cÀ°\n\nThis difference Delta c^l above is negative because water vapor has a lower heat capacity than liquid water.","category":"section"},{"location":"thermodynamics/#Mixed-phase-saturation-vapor-pressure","page":"Thermodynamics","title":"Mixed-phase saturation vapor pressure","text":"In atmospheric conditions near the freezing point, condensate may exist as a mixture of liquid and ice. Following Pressel et al. (2015), we model the saturation vapor pressure over a mixed-phase surface using a liquid fraction Œª that varies smoothly between 0 (pure ice) and 1 (pure liquid). The effective latent heat and specific heat difference for the mixture are computed as weighted averages:\n\n‚Ñí^li_0 = Œª  ‚Ñí^l_0 + (1 - Œª)  ‚Ñí^i_0 \n\nDelta c^li = Œª  Delta c^l + (1 - Œª)  Delta c^i \n\nThese effective properties are then used in the Clausius-Clapeyron formula to compute the saturation vapor pressure over the mixed-phase surface. This approach ensures thermodynamic consistency and smooth transitions between pure liquid and pure ice states.\n\nWe can illustrate this by computing the mixed-phase specific heat difference for a 50/50 mixture:\n\nŒîc‚Å± = thermo.vapor.heat_capacity - thermo.ice.heat_capacity\nŒª = 0.5\nŒîcÀ°‚Å± = Œª * ŒîcÀ° + (1 - Œª) * Œîc‚Å±","category":"section"},{"location":"thermodynamics/#Visualizing-saturation-vapor-pressure","page":"Thermodynamics","title":"Visualizing saturation vapor pressure","text":"The saturation vapor pressure over liquid, ice, and mixed-phase surfaces can be computed and visualized:\n\nusing Breeze\nusing Breeze.Thermodynamics: saturation_vapor_pressure, PlanarMixedPhaseSurface\n\nthermo = ThermodynamicConstants()\n\nT = collect(200:0.1:320)\np·µõÀ°‚Å∫ = [saturation_vapor_pressure(T‚Å±, thermo, thermo.liquid) for T‚Å± in T]\np·µõ‚Å±‚Å∫ = [saturation_vapor_pressure(T‚Å±, thermo, thermo.ice) for T‚Å± in T]\np·µõ‚Å±‚Å∫[T .> thermo.triple_point_temperature] .= NaN\n\n# Mixed-phase surface with 50% liquid, 50% ice\nmixed_surface = PlanarMixedPhaseSurface(0.5)\np·µõ·µê‚Å∫ = [saturation_vapor_pressure(T‚Å±, thermo, mixed_surface) for T‚Å± in T]\n\nusing CairoMakie\n\nfig = Figure()\nax = Axis(fig[1, 1], xlabel=\"Temperature (·µíK)\", ylabel=\"Saturation vapor pressure p·µõ‚Å∫ (Pa)\",\n          yscale = log10, xticks=200:20:320)\nlines!(ax, T, p·µõÀ°‚Å∫, label=\"liquid\", linewidth=2)\nlines!(ax, T, p·µõ‚Å±‚Å∫, label=\"ice\", linestyle=:dash, linewidth=2)\nlines!(ax, T, p·µõ·µê‚Å∫, label=\"mixed (Œª=0.5)\", linestyle=:dot, linewidth=2, color=:purple)\naxislegend(ax, position=:rb)\nfig\n\nThe mixed-phase saturation vapor pressure lies between the liquid and ice curves, providing a smooth interpolation between the two pure phases.","category":"section"},{"location":"thermodynamics/#Saturation-specific-humidity","page":"Thermodynamics","title":"Saturation specific humidity","text":"The saturation specific humidity q·µõ is the maximum amount of water vapor that can exist in equilibrium with a condensed phase at a given temperature and density. It is related to the saturation vapor pressure by:\n\nq·µõ  fracœÅ·µõœÅ = fracp·µõœÅ R·µõ T \n\nwhere œÅ·µõ is the vapor density at saturation, œÅ is the total air density, and R·µõ is the specific gas constant for water vapor.","category":"section"},{"location":"thermodynamics/#Visualizing-saturation-vapor-pressure-and-specific-humidity","page":"Thermodynamics","title":"Visualizing saturation vapor pressure and specific humidity","text":"We can visualize how both saturation vapor pressure and saturation specific humidity vary with temperature for different liquid fractions, demonstrating the smooth interpolation provided by the mixed-phase model:\n\nusing Breeze\nusing Breeze.Thermodynamics: saturation_vapor_pressure, saturation_specific_humidity, PlanarMixedPhaseSurface\n\nthermo = ThermodynamicConstants()\n\n# Temperature range covering typical atmospheric conditions\nT = collect(250:0.1:320)\np‚ÇÄ = 101325  # Surface pressure (Pa)\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\n\n# Liquid fractions to visualize\nŒª_values = [0.0, 0.25, 0.5, 0.75, 1.0]\nlabels = [\"ice (Œª=0)\", \"Œª=0.25\", \"Œª=0.5\", \"Œª=0.75\", \"liquid (Œª=1)\"]\ncolors = [:blue, :cyan, :purple, :orange, :red]\nlinestyles = [:solid, :dash, :dot, :dashdot, :solid]\n\nusing CairoMakie\n\nfig = Figure(size=(1000, 400))\n\n# Panel 1: Saturation vapor pressure\nax1 = Axis(fig[1, 1], xlabel=\"Temperature (K)\", ylabel=\"Saturation vapor pressure (Pa)\",\n           yscale=log10, title=\"Saturation vapor pressure\")\n\nfor (i, Œª) in enumerate(Œª_values)\n    surface = PlanarMixedPhaseSurface(Œª)\n    p·µõ‚Å∫ = [saturation_vapor_pressure(T‚Å±, thermo, surface) for T‚Å± in T]\n    lines!(ax1, T, p·µõ‚Å∫, label=labels[i], color=colors[i], linestyle=linestyles[i], linewidth=2)\nend\n\naxislegend(ax1, position=:lt)\n\n# Panel 2: Saturation specific humidity\nax2 = Axis(fig[1, 2], xlabel=\"Temperature (K)\", ylabel=\"Saturation specific humidity (kg/kg)\",\n           title=\"Saturation specific humidity\")\n\nfor (i, Œª) in enumerate(Œª_values)\n    surface = PlanarMixedPhaseSurface(Œª)\n    q·µõ‚Å∫ = zeros(length(T))\n    for (j, T‚Å±) in enumerate(T)\n        œÅ = p‚ÇÄ / (R·µà * T‚Å±)  # Approximate density using dry air\n        q·µõ‚Å∫[j] = saturation_specific_humidity(T‚Å±, œÅ, thermo, surface)\n    end\n    lines!(ax2, T, q·µõ‚Å∫, label=labels[i], color=colors[i], linestyle=linestyles[i], linewidth=2)\nend\n\nfig\n\nThis figure shows how the liquid fraction Œª smoothly interpolates between pure ice (Œª = 0) and pure liquid (Œª = 1). At lower temperatures, the differences between phases are more pronounced. The mixed-phase model allows for realistic representation of conditions near the freezing point where both liquid and ice may coexist.","category":"section"},{"location":"thermodynamics/#Moist-static-energy","page":"Thermodynamics","title":"Moist static energy","text":"For moist air, a convenient thermodynamic invariant that couples temperature, composition, and height is the moist static energy (MSE),\n\ne  c·µñ·µê  T + g z - LÀ°·µ£  qÀ° - L‚Å±·µ£ q‚Å± \n\nnote: The alternative 'frozen moist static energy' variable\nAn alternative, physically equivalent, definition of moist static energy used in atmospheric models such as the Global System for Atmospheric Modeling (GSAM) (Khairoutdinov et al., 2022) iseÃÉ  c·µñ·µê  T + g z + LÀ°·µ£  q·µõ - L·∂†·µ£ q‚Å± e and eÃÉ are not the same, but they obey the same conservation equation provided that total moisture fraction is conserved, or that mathrmDq·µó  mathrmDt = 0.","category":"section"},{"location":"thermodynamics/#Liquid-ice-potential-temperature","page":"Thermodynamics","title":"Liquid-ice potential temperature","text":"","category":"section"},{"location":"appendix/notation/#Notation","page":"Notation","title":"Notation","text":"This appendix establishes a common notation across the documentation and source code. Each entry lists a mathematical symbol and the Unicode form commonly used in the codebase, along with a common \"property name\", and a description. The property names may take a verbose \"English form\" or concise \"mathematical form\" corresponding to the given Unicode symbol. As properties, mathematical names are usually used mathematical form is invoked for the elements of a NamedTuple. Mathematical symbols are shown with inline math, while the Unicode column shows the exact glyphs used in code.\n\nA few notes about the following table:\n\nTC stands for ThermodynamicConstants\nAM stands for AtmosphereModel\nRS stands for ReferenceState\nthermo refers to an instance of ThermodynamicConstants()\nq refers to an instance of  MoistureMassFractions\n\"Reference\" quantities use a subscript r (e.g., p_r, rho_r).\nNote that there are independent concepts of \"reference\". For example, AnelasticFormulation involves a \"reference state\", which is an adiabatic, hydrostatic solution to the equations of motion. But there is also an \"energy reference temperature\" and \"reference latent heat\", which are thermodynamic constants required to define the internal energy of moist atmospheric constituents.\nPhase or mixture identifiers (d, v, m) appear as superscripts (e.g., R·µà, c·µñ·µê), matching usage in the codebase (e.g., R·µà, c·µñ·µê).\nConservative variables are stored in œÅ·µ£-weighted form in the code (e.g., œÅu, œÅv, œÅw, œÅe, œÅq·µó).\nMapping to AM fields: œÅe corresponds to model.energy_density, œÅq·µó to model.moisture_density, and q·µó to model.specific_moisture.\n\nmath symbol code property name description\nrho œÅ AM.density Density, œÅ = p·µ£  R·µê T for anelastic\nalpha Œ±  Specific volume, Œ± = 1œÅ\nboldsymbolu = (uvw) u, v, w AM.velocities Velocity components in (x, y, z) or (east, north, up)\nboldsymbolœÅu = (œÅu œÅv œÅw ) œÅu, œÅv, œÅw AM.momentum Momentum components\nœÅ e œÅe AM.energy_density Energy density\nT T AM.temperature Temperature\np p AM.pressure Pressure\nb b  Buoyancy\nœÅ q·µó œÅq·µó AM.moisture_density Total moisture density\nq·µó q·µó AM.specific_moisture Total specific moisture (the sum of vapor, liquid, and ice mass fractions)\nq·µõ q·µõ AM.microphysical_fields.q·µõ Vapor mass fraction, a.k.a \"specific humidity\"\nqÀ° qÀ° AM.microphysical_fields.qÀ° Liquid mass fraction\nq‚Å± q‚Å± AM.microphysical_fields.q‚Å± Ice mass fraction\nq·∂ú‚Å± q·∂úÀ° AM.microphysical_fields.q·∂úÀ° Cloud liquid mass fraction\nq^ci q·∂ú‚Å± AM.microphysical_fields.q·∂ú‚Å± Cloud ice mass fraction\nq^r q ≥  Rain mass fraction\nq^s qÀ¢  Snow mass fraction\nœÅq^v œÅq·µõ  Vapor density\nœÅqÀ° œÅqÀ°  Liquid density\nœÅq‚Å± œÅq‚Å±  Ice density\nœÅq·∂úÀ° œÅq·∂úÀ°  Cloud liquid density\nœÅq·∂ú‚Å± œÅq·∂ú‚Å±  Cloud ice density\nœÅq ≥ œÅq ≥ AM.microphysical_fields.œÅq ≥ Rain density\nœÅqÀ¢ œÅqÀ¢ AM.microphysical_fields.œÅqÀ¢ Snow density\nq·µõ q·µõ‚Å∫  Saturation specific humidity over a surface\nq·µõÀ° q·µõ‚Å∫À°  Saturation specific humidity over a planar liquid surface\nq·µõ‚Å± q·µõ‚Å∫‚Å±  Saturation specific humidity over a planar ice surface\ng g TC.gravitational_acceleration Gravitational acceleration\nmathcalR ‚Ñõ TC.molar_gas_constant Universal (molar) gas constant\nT·µó ≥ T·µó ≥ TC.triple_point_temperature Temperature at the vapor-liquid-ice triple point\np·µó ≥ p·µó ≥ TC.triple_point_pressure Pressure at the vapor-liquid-ice triple point\nm·µà m·µà TC.dry_air.molar_mass Molar mass of dry air\nm·µõ m·µõ TC.vapor.molar_mass Molar mass of vapor\nR·µà R·µà dry_air_gas_constant(thermo) Dry air gas constant (R·µà = mathcalR  m·µà)\nR·µõ R·µõ vapor_gas_constant(thermo) Water vapor gas constant (R·µõ = mathcalR  m·µõ)\nR·µê R·µê mixture_gas_constant(q, thermo) Mixture gas constant, function of q\nc·µñ·µà c·µñ·µà TC.dry_air.heat_capacity Heat capacity of dry air at constant pressure\nc·µñ·µõ c·µñ·µõ TC.vapor.heat_capacity Heat capacity of vapor at constant pressure\ncÀ° cÀ° TC.liquid.heat_capacity Heat capacity of the liquid phase (incompressible)\nc‚Å± c‚Å± TC.ice.heat_capacity Heat capacity of the ice phase (incompressible)\nc·µñ·µê c·µñ·µê mixture_heat_capacity(q, thermo) Mixture heat capacity at constant pressure\nT·µ£ T·µ£ TC.energy_reference_temperature Reference temperature for internal energy relations and latent heat\nmathcalL^l_r ‚ÑíÀ°·µ£ TC.liquid.reference_latent_heat Latent heat of condensation at the energy reference temperature\nmathcalL^i_r ‚Ñí‚Å±·µ£ TC.ice.reference_latent_heat Latent heat of deposition at the energy reference temperature\nŒ∏‚ÇÄ Œ∏‚ÇÄ RS.potential_temperature (Constant) reference potential temperature for the anelastic formulation\np‚ÇÄ p‚ÇÄ RS.base_pressure Base (surface) reference pressure\nœÅ·µ£ œÅ·µ£ RS.density Density of a dry reference state for the anelastic formulation\nŒ±·µ£ Œ±·µ£  Specific volume of a dry reference state, Œ±·µ£ = R·µà Œ∏‚ÇÄ  p·µ£\np_r p·µ£ RS.pressure Pressure of a dry adiabatic reference pressure for the anelastic formulation\nPi Œ†  Exner function, Œ† = (p·µ£  p‚ÇÄ)^R·µê  c·µñ·µê\nDelta t Œît Simulation.Œît Time step\nboldsymboltau œÑ  Kinematic subgrid/viscous stress tensor (per unit mass)\nboldsymbolmathcalT ùíØ  Dynamic stress tensor used in anelastic momentum, mathcalT = œÅ·µ£ œÑ\nboldsymbolJ J  Dynamic diffusive flux for scalars","category":"section"},{"location":"microphysics/mixed_phase_saturation_adjustment/#section:mixed-phase-saturation-adjustment","page":"Mixed-phase saturation adjustment","title":"Mixed-phase saturation adjustment","text":"Mixed-phase saturation adjustment extends the warm-phase model to temperatures between the homogeneous ice nucleation temperature and the freezing point, where condensate may exist as a mixture of liquid and ice.\n\nWe assume instantaneous adjustment to an equilibrium in which vapor is at or below the saturation specific humidity over a temperature-dependent mixed surface. The mixed surface is parameterized by a liquid fraction Œª that varies linearly with temperature between the homogeneous ice nucleation temperature T ∞ and the freezing temperature T·∂†.","category":"section"},{"location":"microphysics/mixed_phase_saturation_adjustment/#Equilibrium-surface-model","page":"Mixed-phase saturation adjustment","title":"Equilibrium surface model","text":"Let T be temperature. Define the clamped temperature\n\nT = mathrmclamp(T T^h T^f) \n\nwhere mathrmclamp(x x_min x_max) limits values of x within range x_min x_max, and the liquid fraction\n\nlambda(T) = fracT - T^fT^h - T^f  qquad lambda in 0 1 \n\nA value of Œª = 1 corresponds to a pure liquid surface (warm side); Œª = 0 corresponds to a pure ice surface (cold side). This model yields a mixed-phase surface with effective latent heat and heat-capacity difference that are linear blends of the pure-phase values, consistent with Pressel et al. (2015).\n\nIn Breeze, the equilibrium surface is constructed internally via PlanarMixedPhaseSurface(Œª) using MixedPhaseEquilibrium, and is accessed by\n\nusing Breeze\nusing Breeze.Microphysics: MixedPhaseEquilibrium\n\nFT = Float64\nthermo = ThermodynamicConstants(FT)\n\n# Define equilibrium with default temperatures (T·∂† = 273.15 K, T ∞ = 233.15 K)\neq = MixedPhaseEquilibrium(FT)","category":"section"},{"location":"microphysics/mixed_phase_saturation_adjustment/#Saturation-specific-humidity-across-the-mixed-phase-range","page":"Mixed-phase saturation adjustment","title":"Saturation specific humidity across the mixed-phase range","text":"We can compute the saturation specific humidity across the entire range from homogeneous ice nucleation up to freezing using the equilibrium model above:\n\nusing Breeze.Microphysics: adjustment_saturation_specific_humidity\n\np = 101325.0\nq·µó = 0.012\n\nT·∂† = eq.freezing_temperature\nT ∞ = eq.homogeneous_ice_nucleation_temperature\nT = range(T ∞ - 10, T·∂† + 10; length=81) # slightly beyond the mixed-phase range\n\nq·µõ‚Å∫ = [adjustment_saturation_specific_humidity(T ≤, p, q·µó, thermo, eq) for T ≤ in T]\n\nOptionally, we can visualize how q·µõ‚Å∫ varies with temperature:\n\nusing CairoMakie\n\nfig = Figure()\nax = Axis(fig[1, 1], xlabel=\"Temperature (K)\", ylabel=\"q·µõ‚Å∫ (kg kg‚Åª¬π)\")\nlines!(ax, T, q·µõ‚Å∫)\nfig","category":"section"},{"location":"microphysics/mixed_phase_saturation_adjustment/#Liquid/ice-partitioning-of-condensate","page":"Mixed-phase saturation adjustment","title":"Liquid/ice partitioning of condensate","text":"Under mixed-phase saturation adjustment, excess total moisture is partitioned between liquid and ice according to the temperature-dependent liquid fraction Œª(T) implied by the equilibrium surface. Given total moisture q·µó and saturation specific humidity q·µõ‚Å∫(T), the condensate amount is\n\nq^mathrmcond = max(0 q^t - q^v+)  qquad\nq^l = lambda(T) q^mathrmcond  quad\nq^i = 1 - lambda(T) q^mathrmcond \n\n# Compute partitioning across temperature range\nT‚Ä≤ = clamp.(T, T ∞, T·∂†)\nŒª = @. (T‚Ä≤ - T·∂†) / (T ∞ - T·∂†)\nqcond = @. max(0, q·µó - q·µõ‚Å∫)\n\nqÀ° = Œª .* qcond\nq‚Å± = (1 .- Œª) .* qcond\n\nfig = Figure()\nax = Axis(fig[1, 1], xlabel=\"Temperature (K)\", ylabel=\"Specific humidity (kg kg‚Åª¬π)\")\nlines!(ax, T, qÀ°, label=\"liquid\")\nlines!(ax, T, q‚Å±, label=\"ice\")\naxislegend(ax, position=:lc)\nfig","category":"section"},{"location":"microphysics/mixed_phase_saturation_adjustment/#Notes","page":"Mixed-phase saturation adjustment","title":"Notes","text":"Warm-phase saturation adjustment is recovered for T ‚â• T·∂† (Œª = 1, all liquid) and ice-phase saturation for T ‚â§ T ∞ (Œª = 0, all ice).\nThe moist static energy in Breeze includes both liquid and ice latent heats in mixed-phase conditions:\ne = c·µñ·µê T + g z - ‚ÑíÀ°·µ£ qÀ° - ‚Ñí‚Å±·µ£ q‚Å± \n\nFor details about the saturation adjustment algorithm itself and moist static energy, see the Warm-phase saturation adjustement.","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#sec:warm-saturation-adjustment","page":"Warm-phase saturation adjustment","title":"Warm-phase saturation adjustment","text":"Warm-phase saturation adjustment is a model for water droplet nucleation that assumes that water vapor in excess of the saturation specific humidity is instantaneously converted to liquid water. Mixed-phase saturation adjustment is described by Pressel et al. (2015).","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#Moist-static-energy-and-total-moisture-mass-fraction","page":"Warm-phase saturation adjustment","title":"Moist static energy and total moisture mass fraction","text":"The saturation adjustment solver (specific to our anelastic formulation) takes four inputs:\n\nmoist static energy e,\ntotal moisture mass fraction q·µó,\nheight z, and\nreference pressure p·µ£.\n\nNote that moist static energy density œÅ·µ£ e and moisture density œÅ·µ£ q·µó are prognostic variables for AtmosphereModel when using AnelasticFormulation, where œÅ·µ£ is the reference density. With warm-phase microphysics, the moist static energy e is related to temperature T, height z, and liquid mass fraction qÀ° by\n\ne  c·µñ·µê  T + g z - ‚ÑíÀ°·µ£ qÀ° \n\nwhere c·µñ·µê is the mixture heat capacity, g is gravitational acceleration, and ‚ÑíÀ°·µ£ is the latent heat at the energy reference temperature.","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity","page":"Warm-phase saturation adjustment","title":"Equilibrium expressions for moist static energy and saturation specific humidity","text":"Saturation adjustment microphysics assumes that temperature and the moisture mass fractions instantaneously adjust to an equilibrium in which the specific humidity is equal to or less than the saturation specific humidity. This equilibrium condition implies that the liquid mass fraction qÀ° is given by\n\nqÀ° = max(0 q·µó - q·µõ)\n\nwhere q·µó is the total moisture mass fraction, and q·µõ is the saturation specific humidity at the temperature T. The saturation specific humidity is defined as\n\nq·µõ = fracœÅ·µõœÅ\n\nwhere œÅ·µõ = p·µõ  R·µõ T is the density associated with the saturation vapor pressure p·µõ and R·µõ is the vapor gas constant. Note that the air density œÅ itself depends on the specific humidity, since according to the ideal gas law,\n\nœÅ = fracp·µ£R·µê T = fracp·µ£left (q·µà R·µà + q·µõ R·µõ right ) T \n\nwhere q·µà = 1 - q·µó is the dry air mass fraction, q·µõ is the specific humidity, R·µà is the dry air gas constant, and R·µõ is the vapor gas constant. The density œÅ is expressed in terms of p·µ£ under the anelastic approximation.\n\nIn saturated conditions, we have q·µõ  q·µõ by definition, which leads to the expression\n\nq·µõ = fracœÅ·µõœÅ = fracR·µêR·µõ fracp·µõp·µ£ = fracR·µàR·µõ left ( 1 - q·µó right ) fracp·µõp·µ£ + q·µõ fracp·µõp·µ£ \n\nRearranging, we find a new expression for the saturation specific humidity which is valid only in saturated conditions and under the assumptions of saturation adjustment,\n\nq·µõ = fracR·µàR·µõ left ( 1 - q·µó right ) fracp·µõp·µ£ - p·µõ \n\nThis expression can also be found in paper by Pressel et al. (2015), equation (37).","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#The-saturation-adjustment-algorithm","page":"Warm-phase saturation adjustment","title":"The saturation adjustment algorithm","text":"We compute the saturation adjustment temperature by solving the nonlinear algebraic equation\n\n0 = r(T)  T - frac1c·µñ·µê left  e - g z + ‚ÑíÀ°·µ£ max(0 q·µó - q·µõ) right  \n\nwhere r is the \"residual\", using a secant method.\n\nAs an example, we consider an air parcel at sea level within a reference state with base pressure of 101325 Pa and a surface temperature T‚ÇÄ = 288·µíK. We first compute the saturation specific humidity assuming a dry-air density,\n\nusing Breeze\nusing Breeze.Thermodynamics: saturation_specific_humidity\n\nthermo = ThermodynamicConstants()\n\np = 101325.0\nT = 288.0\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\nœÅ = p / (R·µà * T)\nq·µõ‚Å∫‚ÇÄ = saturation_specific_humidity(T, œÅ, thermo, thermo.liquid)\n\nNext, we compute the saturation specific humidity for moist air with a carefully chosen moist air mass fraction,\n\nusing Breeze.Microphysics: adjustment_saturation_specific_humidity, WarmPhaseEquilibrium\n\nq·µó = 0.012   # [kg kg‚Åª¬π] total specific humidity\nq·µõ‚Å∫ = Breeze.Microphysics.adjustment_saturation_specific_humidity(T, p, q·µó, thermo, WarmPhaseEquilibrium())\n\nThere are two facts of note. First is that we have identified a situation in which q·µó  q·µõ, since q·µó = 0012 and q·µõ = 00104. Second, note that the saturation specific humidity is higher if we assume a saturated state, versus the unsaturated result given by q·µõ‚ÇÄ above. This is because moist air is less dense than dry air, so the denominator œÅ is smaller under the assumption of a saturated state.\n\nIn equilibrium (and thus under the assumptions of saturation adjustment), the specific humidity is q·µõ = q·µõ, while the liquid mass fraction is\n\nqÀ° = q·µó - q·µõ‚Å∫\n\nIt is small but greater than zero ‚Üí the typical situation in clouds on Earth. We are now ready to compute moist static energy,\n\nusing Breeze.Thermodynamics: MoistureMassFractions\n\nq = MoistureMassFractions(q·µõ‚Å∫, qÀ°)\nc·µñ·µê = mixture_heat_capacity(q, thermo)\ng = thermo.gravitational_acceleration\nz = 0.0\n‚ÑíÀ°·µ£ = thermo.liquid.reference_latent_heat\ne = c·µñ·µê * T + g * z - ‚ÑíÀ°·µ£ * qÀ°\n\nMoist static energy has units mathrmm^2  s^2, or mathrmJ  mathrmkg. Next we show that the saturation adjustment solver recovers the input temperature by passing it an \"unadjusted\" moisture mass fraction into Breeze.Microphysics.compute_temperature,\n\nusing Breeze.Microphysics: compute_temperature\n\nmicrophysics = SaturationAdjustment(equilibrium=WarmPhaseEquilibrium())\n\nq‚ÇÄ = MoistureMassFractions(q·µó)\nùí∞ = Breeze.Thermodynamics.MoistStaticEnergyState(e, q‚ÇÄ, z, p)\nT‚òÖ = compute_temperature(ùí∞, microphysics, thermo)\n\nFinally, we note that the saturation adjustment solver is initialized with a guess corresponding to the temperature in unsaturated conditions,\n\nc·µñ·µê‚ÇÅ = mixture_heat_capacity(q‚ÇÄ, thermo)\nT‚ÇÅ = (e - g * z) / c·µñ·µê‚ÇÅ\n\nThe difference between T‚ÇÅ and the solution T_mathrmeq is T_mathrmeq - T‚ÇÅ = ‚ÑíÀ°·µ£ qÀ°  c·µñ·µê and is therefore strictly positive. In other words, T‚ÇÅ represents a lower bound.\n\nTo generate a second guess for the secant solver, we start by estimating the liquid mass fraction using the guess T = T‚ÇÅ,\n\nq·µõ‚Å∫‚ÇÇ = adjustment_saturation_specific_humidity(T‚ÇÅ, p, q·µó, thermo, WarmPhaseEquilibrium())\nqÀ°‚ÇÅ = q·µó - q·µõ‚Å∫‚ÇÇ\n\nIn general, this represents an overestimate of the liquid mass fraction, because q·µõ‚ÇÇ is underestimated by the too-low temperature T‚ÇÅ. We thus increment the first guess by half of the difference implied by the estimate qÀ°‚ÇÅ,\n\nq‚ÇÇ = MoistureMassFractions(q·µõ‚Å∫‚ÇÇ, qÀ°‚ÇÅ)\nc·µñ·µê‚ÇÇ = mixture_heat_capacity(q‚ÇÇ, thermo)\nŒîT = ‚ÑíÀ°·µ£ * qÀ°‚ÇÅ / c·µñ·µê‚ÇÇ\nT‚ÇÇ = T‚ÇÅ + ŒîT / 2\n\nThe residual looks like\n\nusing Breeze.Microphysics: saturation_adjustment_residual\nusing CairoMakie\n\nequilibrium = WarmPhaseEquilibrium()\nT = 230:0.5:320\nr = [saturation_adjustment_residual(T ≤, ùí∞, thermo, equilibrium) for T ≤ in T]\nq·µõ‚Å∫ = [adjustment_saturation_specific_humidity(T ≤, p, q·µó, thermo, equilibrium) for T ≤ in T]\n\nfig = Figure()\naxr = Axis(fig[1, 1], xlabel=\"Temperature (K)\", ylabel=\"Saturation adjustment residual (K)\")\naxq = Axis(fig[2, 1], xlabel=\"Temperature (K)\", ylabel=\"Estimated liquid fraction\")\nlines!(axr, T, r)\nscatter!(axr, 288, 0, marker=:star5, markersize=30, color=:tomato)\n\nlines!(axq, T, max.(0, q·µó .- q·µõ‚Å∫))\n\nfig\n\nThere is a kink at the temperature wherein the estimated liquid mass fraction bottoms out.","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#Equilibrium-states-with-varying-total-specific-humidity","page":"Warm-phase saturation adjustment","title":"Equilibrium states with varying total specific humidity","text":"As a second example, we examine the dependence of temperature on total specific humidity when the moist static energy is held fixed.\n\nusing Breeze.Thermodynamics: MoistStaticEnergyState\n\nT‚ÇÄ = 288\nc·µñ·µà = thermo.dry_air.heat_capacity\ne‚ÇÄ = c·µñ·µà * T‚ÇÄ # representative value\nz = 0.0\np = 101325.0\n\n# Vary the total moisture mass fraction:\nq·µó = 0:1e-4:0.035 # [kg kg‚Åª¬π]\n\nT = zeros(length(q·µó))\nqÀ° = zeros(length(q·µó))\n\nfor (i, q·µó‚Å±) in enumerate(q·µó)\n    q = MoistureMassFractions(q·µó‚Å±)\n    ùí∞ = MoistStaticEnergyState(e‚ÇÄ, q, z, p)\n    T[i] = compute_temperature(ùí∞, microphysics, thermo)\n    q·µõ‚Å∫ = Breeze.Microphysics.adjustment_saturation_specific_humidity(T[i], p, q·µó‚Å±, thermo, WarmPhaseEquilibrium())\n    qÀ°[i] = max(0, q·µó‚Å± - q·µõ‚Å∫)\nend\n\nusing CairoMakie\n\n# Hard code the transition index here, e.g. 105 (adjust to your needs)\ntransition_idx = 105\n\nfig = Figure()\naxT = Axis(fig[1, 1], xlabel=\"Total specific humidity (kg kg‚Åª¬π)\", ylabel=\"Temperature (·µíK)\")\naxq = Axis(fig[2, 1], xlabel=\"Total specific humidity (kg kg‚Åª¬π)\", ylabel=\"Liquid mass fraction\")\n\nlines!(axT, q·µó, T)\nlines!(axq, q·µó, qÀ°)\n\nidx = searchsortedfirst(qÀ°, 1e-4)\nvlines!(axT, q·µó[idx], color=:gray, linestyle=:dash, linewidth=2)\nvlines!(axq, q·µó[idx], color=:gray, linestyle=:dash, linewidth=2)\n\ntext!(axq, \"unsaturated, clear\", position=(q·µó[idx-5], 4e-3), align=(:right, :top))\ntext!(axq, \"saturated and cloudy ‚Üí\", position=(q·µó[idx+5], 8e-3), align=(:left, :top))\n\nfig","category":"section"},{"location":"microphysics/warm_phase_saturation_adjustment/#Saturation-adjustment-with-varying-height","page":"Warm-phase saturation adjustment","title":"Saturation adjustment with varying height","text":"For a third example, we consider a state with constant moist static energy and total specific humidity (equivalently, a constant Œ∏ in this reference state), but at varying heights:\n\nusing Breeze\n\ngrid = RectilinearGrid(size=100, z=(0, 1e4), topology=(Flat, Flat, Bounded))\nthermo = ThermodynamicConstants()\n\nŒ∏‚ÇÄ = 288\np‚ÇÄ = 101325\nreference_state = ReferenceState(grid, thermo;\n                                 base_pressure = p‚ÇÄ,\n                                 potential_temperature = Œ∏‚ÇÄ)\n\nq·µó = 0.005\nq = MoistureMassFractions(q·µó)\n\nz = znodes(grid, Center())\nT = zeros(grid.Nz)\nq·µõ‚Å∫ = zeros(grid.Nz)\nqÀ° = zeros(grid.Nz)\nrh = zeros(grid.Nz)\n\n# Set a constant moist static energy referenced to z = 0, clear air\nc·µñ·µê = mixture_heat_capacity(q, thermo)\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\ng = thermo.gravitational_acceleration\n\nfor k = 1:grid.Nz\n    p·µ£ = reference_state.pressure[1, 1, k]\n    T·µ£ = Œ∏‚ÇÄ * (p·µ£ / p‚ÇÄ)^(R·µà / c·µñ·µà)\n    e‚ÇÄ = c·µñ·µê * T·µ£ + g * z[k]\n    ùí∞ = MoistStaticEnergyState(e‚ÇÄ, q, z[k], p·µ£)\n    T[k] = compute_temperature(ùí∞, microphysics, thermo)\n\n    # Saturation specific humidity via adjustment formula using T[k], p·µ£, and q·µó\n    q·µõ‚Å∫[k] = Breeze.Microphysics.adjustment_saturation_specific_humidity(T[k], p·µ£, q·µó, thermo, WarmPhaseEquilibrium())\n    qÀ°[k] = max(0, q·µó - q·µõ‚Å∫[k])\n    rh[k] = 100 * min(q·µó, q·µõ‚Å∫[k]) / q·µõ‚Å∫[k]\nend\n\nc·µñ·µà = thermo.dry_air.heat_capacity\ng = thermo.gravitational_acceleration\n\nfig = Figure(size=(700, 350))\n\nyticks = 0:2e3:10e3\n\naxT = Axis(fig[1, 1:2]; xlabel = \"Temperature (·µíK)\", ylabel = \"Height (m)\", yticks)\naxq‚Å∫ = Axis(fig[1, 3]; xlabel = \"Saturation\\n specific humidity\\n (kg kg‚Åª¬π)\",\n                       yticks, yticklabelsvisible = false)\naxqÀ° = Axis(fig[1, 4]; xlabel = \"Liquid\\n specific humidity\\n (kg kg‚Åª¬π)\",\n                       yticks, yticklabelsvisible = false)\n\naxrh = Axis(fig[1, 5]; xlabel = \"Relative\\n humidity (%)\",\n                       xticks = 0:20:100,\n                       yticks, yticklabelsvisible = false)\n\nlines!(axT, T, z)\nlines!(axT, T[1] .- g * z / c·µñ·µà, z, linestyle = :dash, color = :orange, linewidth = 2)\nlines!(axq‚Å∫, q·µõ‚Å∫, z)\nlines!(axqÀ°, qÀ°, z)\nlines!(axrh, rh, z)\n\nfig","category":"section"},{"location":"developer/microphysics_interface/#AtmosphereModel-microphysics-interface","page":"Microphysics Interface","title":"AtmosphereModel microphysics interface","text":"This document describes the interface for embedding microphysical processes into AtmosphereModel. The interface consists of eight functions that must be implemented for any microphysics scheme to work with AtmosphereModel.","category":"section"},{"location":"developer/microphysics_interface/#Overview","page":"Microphysics Interface","title":"Overview","text":"The microphysics interface consists of seven functions, each of which must be implemented to complete a microphysics implementation in AtmosphereModel:\n\nBreeze.AtmosphereModels.prognostic_field_names\nDefines the names of the prognostic microphysical fields\nBreeze.AtmosphereModels.materialize_microphysical_fields\n\"Materializes\" or generates, given the model grid and boundary_conditions, a NamedTuple of microphysical fields.\nThe NamedTuple of microphysical fields must include prognostic fields, but can also include additional diagnostic fields.\nNote, boundary_conditions can only be supplied to prognostic fields.\nBreeze.AtmosphereModels.update_microphysical_fields!\nUpdate the diagnostic microphysics fields. This should not touch the prognostic fields.\nBreeze.AtmosphereModels.maybe_adjust_thermodynamic_state\nPossibly adjust the thermodynamic state according to some constraint, such as saturation adjustment.\nBreeze.AtmosphereModels.compute_moisture_fractions\nGiven the model state, return a MoistureMassFractions object\nBreeze.AtmosphereModels.microphysical_velocities\nBuild the differential velocity field that microphysical tracers experience in addition to the bulk velocity (for example, the terminal velocity of falling hydrometeors)\nBreeze.AtmosphereModels.microphysical_tendency\nAdd additional tendency terms to the microphysical tracer equations representing for example, condensation, evaporation, or autoconversion of cloud liquid and ice content to snow or rain.","category":"section"},{"location":"developer/microphysics_interface/#Example-implementation","page":"Microphysics Interface","title":"Example implementation","text":"To illustrate the development of a new microphysics scheme, we implement a  simple microphysics scheme that represents droplet and ice particle nucleation with constant-rate relaxation of specific humidity to saturation.\n\nusing Breeze\n\nstruct ExplicitMicrophysics{FT}\n    vapor_to_liquid :: FT\n    vapor_to_ice :: FT\nend","category":"section"},{"location":"developer/microphysics_interface/#Prognostic-field-names-and-materializing-prognostic-diagnostic-fields","page":"Microphysics Interface","title":"Prognostic field names and materializing prognostic + diagnostic fields","text":"This scheme is fully prognostic, which means we must carry around vapor, liquid and ice density as prognostic variables,\n\nimport Breeze.AtmosphereModels: prognostic_field_names\n\nprognostic_field_names(::ExplicitMicrophysics) = (:œÅq·µõ, :œÅqÀ°, :œÅq‚Å±)\n\nnote: Note\nThe names of prognostic fields defined by prognostic_field_names  are crucial to the user interface, because users can interact them and set! their initial conditions. The names of variables should be carefully chosen to be concise, mathematical forms that are consistent with Breeze conventions.\n\nWhen we materialize the microphysics fields, we must include all of the prognostic fields in addition to diagnostic fields (this behavior may change in the future):\n\nimport Breeze.AtmosphereModels: materialize_microphysical_fields\n\nfunction materialize_microphysical_fields(::ExplicitMicrophysics, grid, boundary_conditions)\n    œÅq·µõ = CenterField(grid, boundary_conditions=boundary_Conditions.œÅq·µõ)\n    œÅqÀ° = CenterField(grid, boundary_conditions=boundary_Conditions.œÅqÀ°)\n    œÅq‚Å± = CenterField(grid, boundary_conditions=boundary_Conditions.œÅq‚Å±)\n    q·µõ = CenterField(grid)\n    return (; œÅqÀ°, œÅq‚Å±, œÅq·µõ, q·µõ)\nend\n\nThe tendencies for \n\nimport Breeze.AtmosphereModels: microphysical_tendency\n\nusing Breeze.Thermodynamics:\n    PlanarLiquidSurface,\n    PlanarIceSurface\n\n@inline function microphysical_tendency(i, j, k, grid, em::ExplicitMicrophysics, ::Val{:œÅqÀ°}, Œº, ùí∞, thermo)\n    œÅ = 1.2 # density\n    T = temperature(ùí∞, thermo)\n    q‚Å∫À° = saturation_specific_humidity(T, œÅ, thermo, PlanarLiquidSurface())\n    œÑ·µõÀ° = em.vapor_to_liquid\n    return @inbounds œÅ * (Œº.q·µõ[i, j, k] - q‚Å∫À°) / œÑ·µõÀ°\nend\n\n@inline @inbounds function microphysical_tendency(i, j, k, grid,\n    em::ExplicitMicrophysics, ::Val{:œÅq‚Å±}, Œº, ùí∞, thermo)\n\n    œÅ = 1.2 # density\n    q = MoistureMassFractions(q·µõ, qÀ°, q‚Å±)\n    T = temperature(ùí∞, thermo)\n    q‚Å∫‚Å± = saturation_specific_humidity(T, œÅ, thermo, PlanarIceSurface())\n    œÑ·µõ‚Å± = em.vapor_to_ice\n\n    return œÅ * (Œº.q·µõ[i, j, k] - q‚Å∫‚Å±) / œÑ·µõ‚Å±\nend\n\n@inline @inbounds function microphysical_tendency(\n    i, j, k, grid, em::ExplicitMicrophysics, ::Val{:œÅq·µõ}, Œº, ùí∞, thermo)\n\n    S·µõÀ° = microphysical_tendency(i, j, k, grid, em, Val(:œÅvÀ°), Œº, ùí∞, thermo)\n    S·µõ‚Å± = microphysical_tendency(i, j, k, grid, em, Val(:œÅv‚Å±), Œº, ùí∞, thermo)\n    return - S·µõÀ° - S·µõ‚Å±\nend\n\n\nNote we have included the diagnostic field q·µõ (the vapor mass fraction, aka \"specific humidity\") in addition to the three prognostic fields representing vapor, liquid and ice density.","category":"section"},{"location":"developer/microphysics_interface/#Prognostic-field-names-and-materializing-prognostic-diagnostic-fields-2","page":"Microphysics Interface","title":"Prognostic field names and materializing prognostic + diagnostic fields","text":"import Breeze.AtmosphereModels:\n    update_microphysical_fields!,\n    compute_moisture_fraction\n\n@inline update_microphysical_fields!(Œº, em::ExplicitMicrophysics, i, j, k, grid, œÅ, state, thermo) =\n    @inbounds Œº.q·µõ[i, j, k] = state.moisture_mass_fractions.vapor\n\n@inline @inbounds function compute_moisture_fractions(i, j, k, grid,\n    ::ExplicitMicrophysics, œÅ, q·µó, microphysical_fields)\n\n    q·µõ = microphysical_fields.q·µõ[i, j, k]\n    œÅqÀ° = microphysical_fields.œÅqÀ°[i, j, k] / œÅ\n    œÅq‚Å± = microphysical_fields.œÅq‚Å±[i, j, k] / œÅ\n\n    return MoistureMassFractions(q·µõ, qÀ°, q‚Å±)\nend\n\nThis is a fully prognostic  scheme, so there is no adjustment,\n\nimport Breeze.AtmosphereModels: maybe_adjust_thermodynamic_state\n\n@inline maybe_adjust_thermodynamic_state(state, ::ExplicitMicrophysics, Œº, q·µó, thermo) = state","category":"section"},{"location":"api/#API-Documentation","page":"API","title":"API Documentation","text":"","category":"section"},{"location":"api/#Public-API","page":"API","title":"Public API","text":"","category":"section"},{"location":"api/#Thermodynamics","page":"API","title":"Thermodynamics","text":"","category":"section"},{"location":"api/#MoistAirBuoyancies","page":"API","title":"MoistAirBuoyancies","text":"","category":"section"},{"location":"api/#AtmosphereModels","page":"API","title":"AtmosphereModels","text":"","category":"section"},{"location":"api/#Microphysics","page":"API","title":"Microphysics","text":"","category":"section"},{"location":"api/#TurbulenceClosures","page":"API","title":"TurbulenceClosures","text":"","category":"section"},{"location":"api/#Private-API","page":"API","title":"Private API","text":"","category":"section"},{"location":"api/#Thermodynamics-2","page":"API","title":"Thermodynamics","text":"","category":"section"},{"location":"api/#MoistAirBuoyancies-2","page":"API","title":"MoistAirBuoyancies","text":"","category":"section"},{"location":"api/#AtmosphereModels-2","page":"API","title":"AtmosphereModels","text":"","category":"section"},{"location":"api/#Breeze.Breeze","page":"API","title":"Breeze.Breeze","text":"Julia package for finite volume GPU and CPU large eddy simulations (LES) of atmospheric flows. The abstractions, design, and finite volume engine are based on Oceananigans.\n\n\n\n\n\n","category":"module"},{"location":"api/#Breeze.Thermodynamics.CondensedPhase","page":"API","title":"Breeze.Thermodynamics.CondensedPhase","text":"CondensedPhase(; ...)\nCondensedPhase(FT; reference_latent_heat, heat_capacity)\n\n\nReturns CondensedPhase with specified parameters converted to FT.\n\nTwo examples of CondensedPhase are liquid and ice. When matter is converted from vapor to liquid, water molecules in the gas phase cluster together and slow down to form liquid with heat_capacity, The lost of molecular kinetic energy is called the reference_latent_heat.\n\nLikewise, during deposition, water molecules in the gas phase cluster into ice crystals.\n\nArguments\n\nFT: Float type to use (defaults to Oceananigans.defaults.FloatType)\nreference_latent_heat: Difference between the internal energy of the gaseous phase at the energy_reference_temperature.\nheat_capacity: Heat capacity of the phase of matter.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.IdealGas","page":"API","title":"Breeze.Thermodynamics.IdealGas","text":"struct IdealGas{FT}\n\nA struct representing an ideal gas with molar mass and specific heat capacity.\n\nFields\n\nmolar_mass: Molar mass of the gas in kg/mol\nheat_capacity: Specific heat capacity at constant pressure in J/(kg¬∑K)\n\nExamples\n\ndry_air = IdealGas(molar_mass=0.02897, heat_capacity=1005)\n\n# output\nIdealGas{Float64}(molar_mass=0.02897, heat_capacity=1005.0)\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.ReferenceState","page":"API","title":"Breeze.Thermodynamics.ReferenceState","text":"ReferenceState(\n    grid;\n    ...\n) -> ReferenceState{_A, F} where {_A, F<:(Field{Nothing, Nothing, Center, Nothing, G, I, D, T, B, Nothing} where {G, I, D, T, B})}\nReferenceState(\n    grid,\n    thermo;\n    base_pressure,\n    potential_temperature\n) -> ReferenceState{_A, F} where {_A, F<:(Field{Nothing, Nothing, Center, Nothing, G, I, D, T, B, Nothing} where {G, I, D, T, B})}\n\n\nReturn a ReferenceState on grid, with ThermodynamicConstants thermo that includes the adiabatic hydrostatic reference pressure and reference density for a base_pressure and potential_temperature.\n\nArguments\n\ngrid: The grid.\nthermo :: ThermodynamicConstants: By default, ThermodynamicConstants(eltype(grid)).\n\nKeyword arguments\n\nbase_pressure: By default, 101325.\npotential_temperature: By default, 288.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.ThermodynamicConstants","page":"API","title":"Breeze.Thermodynamics.ThermodynamicConstants","text":"ThermodynamicConstants(; ...) -> ThermodynamicConstants\nThermodynamicConstants(\n    FT;\n    molar_gas_constant,\n    gravitational_acceleration,\n    energy_reference_temperature,\n    triple_point_temperature,\n    triple_point_pressure,\n    dry_air_molar_mass,\n    dry_air_heat_capacity,\n    vapor_molar_mass,\n    vapor_heat_capacity,\n    liquid,\n    ice\n) -> ThermodynamicConstants\n\n\nReturn ThermodynamicConstants with parameters that represent gaseous mixture of dry \"air\" and vapor, as well as condensed liquid and ice phases. The triple_point_temperature and triple_point_pressure may be combined with internal energy parameters for condensed phases to compute the vapor pressure at the boundary between vapor and a homogeneous sample of the condensed phase. The gravitational_acceleration parameter is included to compute ReferenceState quantities associated with hydrostatic balance.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.mixture_gas_constant-Tuple{Breeze.Thermodynamics.MoistureMassFractions, ThermodynamicConstants}","page":"API","title":"Breeze.Thermodynamics.mixture_gas_constant","text":"mixture_gas_constant(\n    q::Breeze.Thermodynamics.MoistureMassFractions,\n    thermo::ThermodynamicConstants\n) -> Any\n\n\nReturn the gas constant of moist air mixture [in J/(kg K)] given the specific humidity q and thermodynamic parameters thermo.\n\nThe mixture gas constant is calculated as a weighted average of the dry air and water vapor gas thermo:\n\nR·µê = q·µà R·µà + q·µõ R·µõ \n\nwhere:\n\nR·µà is the dry air gas constant,\nR·µõ is the water vapor gas constant,\nq·µà is the mass fraction of dry air, and\nq·µõ is the mass fraction of water vapor.\n\nArguments\n\nq: the moisture mass fractions (vapor, liquid, and ice)\nthermo: ThermodynamicConstants instance containing gas thermo\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Thermodynamics.mixture_heat_capacity-Tuple{Breeze.Thermodynamics.MoistureMassFractions, ThermodynamicConstants}","page":"API","title":"Breeze.Thermodynamics.mixture_heat_capacity","text":"mixture_heat_capacity(\n    q::Breeze.Thermodynamics.MoistureMassFractions,\n    thermo::ThermodynamicConstants\n) -> Any\n\n\nCompute the heat capacity of a mixture of dry air, vapor, liquid, and ice, where the mass fractions of vapor, liquid, and ice are given by q. The heat capacity of moist air is the weighted sum of its constituents:\n\nc·µñ·µê = q·µà c·µñ·µà + q·µõ c·µñ·µõ + qÀ° cÀ° + q‚Å± c‚Å± \n\nwhere q·µõ = q.vapor, qÀ° = q.liquid, q‚Å± = q.ice are the mass fractions of vapor, liquid, and ice constituents, respectively, and q·µà = 1 - q·µõ - qÀ° - q‚Å± is the mass fraction of dry air. The heat capacities c·µñ·µà, c·µñ·µõ, cÀ°, c‚Å± are the heat capacities of dry air, vapor, liquid, and ice at constant pressure, respectively. The liquid and ice phases are assumed to be incompressible.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.MoistAirBuoyancies.MoistAirBuoyancy-Tuple{Any}","page":"API","title":"Breeze.MoistAirBuoyancies.MoistAirBuoyancy","text":"MoistAirBuoyancy(\n    grid;\n    base_pressure,\n    reference_potential_temperature,\n    thermodynamics\n) -> MoistAirBuoyancy{RS, AT} where {RS<:(ReferenceState{_A, F} where {_A, F<:(Field{Nothing, Nothing, Center, Nothing, G, I, D, T, B, Nothing} where {G, I, D, T, B})}), AT<:ThermodynamicConstants}\n\n\nReturn a MoistAirBuoyancy formulation that can be provided as input to an Oceananigans.NonhydrostaticModel.\n\nnote: Required tracers\nMoistAirBuoyancy requires tracers Œ∏ and q·µó.\n\nExample\n\nusing Breeze, Oceananigans\n\ngrid = RectilinearGrid(size=(1, 1, 8), extent=(1, 1, 3e3))\nbuoyancy = MoistAirBuoyancy(grid)\n\n# output\nMoistAirBuoyancy:\n‚îú‚îÄ‚îÄ reference_state: ReferenceState{Float64}(p‚ÇÄ=101325.0, Œ∏‚ÇÄ=288.0)\n‚îî‚îÄ‚îÄ thermodynamics: ThermodynamicConstants{Float64}\n\nTo build a model with MoistAirBuoyancy, we include potential temperature and total specific humidity tracers Œ∏ and q·µó to the model.\n\nmodel = NonhydrostaticModel(; grid, buoyancy, tracers = (:Œ∏, :q·µó))\n\n# output\nNonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n‚îú‚îÄ‚îÄ grid: 1√ó1√ó8 RectilinearGrid{Float64, Periodic, Periodic, Bounded} on CPU with 1√ó1√ó3 halo\n‚îú‚îÄ‚îÄ timestepper: RungeKutta3TimeStepper\n‚îú‚îÄ‚îÄ advection scheme: Centered(order=2)\n‚îú‚îÄ‚îÄ tracers: (Œ∏, q·µó)\n‚îú‚îÄ‚îÄ closure: Nothing\n‚îú‚îÄ‚îÄ buoyancy: MoistAirBuoyancy with gÃÇ = NegativeZDirection()\n‚îî‚îÄ‚îÄ coriolis: Nothing\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.AnelasticFormulation","page":"API","title":"Breeze.AtmosphereModels.AnelasticFormulation","text":"AnelasticFormulation is a dynamical formulation wherein the density and pressure are small perturbations from a dry, hydrostatic, adiabatic reference_state. The prognostic energy variable is the moist static energy density. The energy density equation includes a buoyancy flux term, following Pauluis (2008).\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.AtmosphereModels.AtmosphereModel-Tuple{Any}","page":"API","title":"Breeze.AtmosphereModels.AtmosphereModel","text":"AtmosphereModel(\n    grid;\n    clock,\n    thermodynamics,\n    formulation,\n    moisture_density,\n    tracers,\n    coriolis,\n    boundary_conditions,\n    forcing,\n    advection,\n    closure,\n    microphysics,\n    timestepper\n) -> AtmosphereModel{Frm, Arc, Tst, Grd, Oceananigans.TimeSteppers.Clock{Float64, Float64, Int64, Int64}, Thm, Den, Mom, Eng, Mse, Moi, Mfr, Nothing, Tmp, Prs, Sol, Vel, Trc, Adv, Nothing, Frc, Nothing, @NamedTuple{}, Nothing, Nothing} where {Frm, Arc, Tst, Grd, Thm, Den, Mom, Eng, Mse, Moi, Mfr, Tmp, Prs, Sol, Vel, Trc, Adv, Frc}\n\n\nReturn an AtmosphereModel that uses the anelastic approximation following Pauluis (2008).\n\nExample\n\njulia> using Breeze\n\njulia> grid = RectilinearGrid(size=(8, 8, 8), extent=(1, 2, 3));\n\njulia> model = AtmosphereModel(grid)\nAtmosphereModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n‚îú‚îÄ‚îÄ grid: 8√ó8√ó8 RectilinearGrid{Float64, Periodic, Periodic, Bounded} on CPU with 3√ó3√ó3 halo\n‚îú‚îÄ‚îÄ formulation: AnelasticFormulation(p‚ÇÄ=101325.0, Œ∏‚ÇÄ=288.0)\n‚îú‚îÄ‚îÄ timestepper: RungeKutta3TimeStepper\n‚îú‚îÄ‚îÄ advection scheme: Centered(order=2)\n‚îú‚îÄ‚îÄ tracers: ()\n‚îú‚îÄ‚îÄ coriolis: Nothing\n‚îî‚îÄ‚îÄ microphysics: Nothing\n\nReferences\n\nPauluis, O. (2008). Thermodynamic consistency of the anelastic approximation for a moist atmosphere.   Journal of the Atmospheric Sciences 65, 2719‚Äì2729.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.PotentialTemperature-Tuple{Any}","page":"API","title":"Breeze.AtmosphereModels.PotentialTemperature","text":"PotentialTemperature(\n    model\n) -> KernelFunctionOperation{Center, Center, Center, _A, _B, K, Tuple{}} where {_A, _B, K<:Breeze.AtmosphereModels.PotentialTemperatureKernelFunction}\n\n\nReturn a KernelFunctionOperation representing potential temperature.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.PotentialTemperatureField-Tuple{Any}","page":"API","title":"Breeze.AtmosphereModels.PotentialTemperatureField","text":"PotentialTemperatureField(\n    model\n) -> Field{LX, LY, LZ, O, G, I, D, T, B, Oceananigans.Fields.FieldStatus{Float64}} where {LX, LY, LZ, O, G, I, D, T, B}\n\n\nReturn a Field representing potential temperature.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Microphysics.BulkMicrophysics","page":"API","title":"Breeze.Microphysics.BulkMicrophysics","text":"BulkMicrophysics(\n;\n    ...\n) -> BulkMicrophysics{N, Nothing} where N<:(SaturationAdjustment{E} where E<:MixedPhaseEquilibrium)\nBulkMicrophysics(\n    FT::DataType;\n    categories,\n    nucleation\n) -> BulkMicrophysics{N, Nothing} where N<:(SaturationAdjustment{E} where E<:MixedPhaseEquilibrium)\n\n\nReturn a BulkMicrophysics microphysics scheme with clouds and precipitation microphysics schemes.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Microphysics.MixedPhaseEquilibrium","page":"API","title":"Breeze.Microphysics.MixedPhaseEquilibrium","text":"MixedPhaseEquilibrium(; ...) -> MixedPhaseEquilibrium\nMixedPhaseEquilibrium(\n    FT;\n    freezing_temperature,\n    homogeneous_ice_nucleation_temperature\n) -> MixedPhaseEquilibrium\n\n\nReturn MixedPhaseEquilibrium representing a temperature-dependent equilibrium between water vapor, possibly supercooled liquid water, and ice.\n\nThe equilibrium state is modeled as a linear variation of the equilibrium liquid fraction with temperature, between the freezing temperature (e.g. 273.15 K) below which liquid water is supercooled, and the temperature of homogeneous ice nucleation temperature (e.g. 233.15 K) at which the supercooled liquid fraction vanishes.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Microphysics.SaturationAdjustment","page":"API","title":"Breeze.Microphysics.SaturationAdjustment","text":"SaturationAdjustment(\n;\n    ...\n) -> SaturationAdjustment{E} where E<:MixedPhaseEquilibrium\nSaturationAdjustment(\n    FT::DataType;\n    tolerance,\n    maxiter,\n    equilibrium\n) -> SaturationAdjustment{E} where E<:MixedPhaseEquilibrium\n\n\nReturn SaturationAdjustment microphysics representing an instantaneous adjustment to equilibrium between condensates and water vapor, computed by a solver with tolerance and maxiter.\n\nThe options for equilibrium are:\n\nWarmPhaseEquilibrium() representing an equilibrium between water vapor and liquid water.\nMixedPhaseEquilibrium() representing a temperature-dependent equilibrium between water vapor, possibly supercooled liquid water, and ice. The equilibrium state is modeled as a linear variation of the equilibrium liquid fraction with temperature, between the freezing temperature (e.g. 273.15 K) below which liquid water is supercooled, and the temperature of homogeneous ice nucleation temperature (e.g. 233.15 K) at which the supercooled liquid fraction vanishes.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Microphysics.WarmPhaseEquilibrium","page":"API","title":"Breeze.Microphysics.WarmPhaseEquilibrium","text":"Return WarmPhaseEquilibrium representing an equilibrium between water vapor and liquid water.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Microphysics.adjust_thermodynamic_state-Tuple{Breeze.Thermodynamics.AbstractThermodynamicState, SaturationAdjustment, Any}","page":"API","title":"Breeze.Microphysics.adjust_thermodynamic_state","text":"adjust_thermodynamic_state(\n    ùí∞‚ÇÄ::Breeze.Thermodynamics.AbstractThermodynamicState,\n    microphysics::SaturationAdjustment,\n    thermo\n) -> Breeze.Thermodynamics.AbstractThermodynamicState\n\n\nReturn the saturation-adjusted thermodynamic state using a secant iteration.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Microphysics.compute_temperature-Tuple{Any, SaturationAdjustment, Any}","page":"API","title":"Breeze.Microphysics.compute_temperature","text":"compute_temperature(\n    ùí∞‚ÇÄ,\n    adjustment::SaturationAdjustment,\n    thermo\n) -> Any\n\n\nPerform saturation adjustment and return the temperature associated with the adjusted state.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Thermodynamics.MoistureMassFractions","page":"API","title":"Breeze.Thermodynamics.MoistureMassFractions","text":"struct MoistureMassFractions{FT}\n\nA struct representing the moisture mass fractions of a moist air parcel.\n\nFields\n\nvapor: the mass fraction of vapor\nliquid: the mass fraction of liquid\nice: the mass fraction of ice\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.PlanarMixedPhaseSurface","page":"API","title":"Breeze.Thermodynamics.PlanarMixedPhaseSurface","text":"Return PlanarMixedPhaseSurface for computing the saturation vapor pressure over a surface composed of a mixture of liquid and ice, with a given liquid_fraction.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.Thermodynamics.adiabatic_hydrostatic_density-NTuple{4, Any}","page":"API","title":"Breeze.Thermodynamics.adiabatic_hydrostatic_density","text":"adiabatic_hydrostatic_density(z, p‚ÇÄ, Œ∏‚ÇÄ, thermo) -> Any\n\n\nCompute the reference density at height z that associated with the reference pressure and potential temperature Œ∏‚ÇÄ. The reference density is defined as the density of dry air at the reference pressure and temperature.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Thermodynamics.adiabatic_hydrostatic_pressure-NTuple{4, Any}","page":"API","title":"Breeze.Thermodynamics.adiabatic_hydrostatic_pressure","text":"adiabatic_hydrostatic_pressure(z, p‚ÇÄ, Œ∏‚ÇÄ, thermo) -> Any\n\n\nCompute the reference pressure at height z that associated with the reference pressure p‚ÇÄ and potential temperature Œ∏‚ÇÄ. The reference pressure is defined as the pressure of dry air at the reference pressure and temperature.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Thermodynamics.saturation_specific_humidity-NTuple{4, Any}","page":"API","title":"Breeze.Thermodynamics.saturation_specific_humidity","text":"saturation_specific_humidity(T, œÅ, thermo, surface) -> Any\n\n\nCompute the saturation specific humidity for a gas at temperature T, total density œÅ, thermodynamics, and over surface via:\n\nq·µõ = p·µõ  (œÅ R·µõ T) \n\nwhere p·µõ is the saturation_vapor_pressure over surface, œÅ is total density, and R·µõ is the specific gas constant for water vapor.\n\nExamples\n\nFirst we compute the saturation specific humidity over a liquid surface:\n\nusing Breeze\nusing Breeze.Thermodynamics: PlanarLiquidSurface, PlanarIceSurface, PlanarMixedPhaseSurface\n\nthermo = ThermodynamicConstants()\nT = 288.0 # Room temperature (K)\np = 101325.0 # Mean sea-level pressure\nR·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)\nq = zero(Breeze.Thermodynamics.MoistureMassFractions{Float64})\nœÅ = Breeze.Thermodynamics.density(p, T, q, thermo)\nq·µõ‚Å∫À° = Breeze.Thermodynamics.saturation_specific_humidity(T, œÅ, thermo, PlanarLiquidSurface())\n\n# output\n0.010359995391195264\n\nNote, this is slightly smaller than the saturation specific humidity over an ice surface:\n\njulia> q·µõ‚Å∫À° = Breeze.Thermodynamics.saturation_specific_humidity(T, œÅ, thermo, PlanarIceSurface())\n0.011945100768555072\n\nIf a medium contains a mixture of 40% water and 60% ice that has (somehow) acquired thermodynamic equilibrium, we can compute the saturation specific humidity over the mixed phase surface,\n\nmixed_surface = PlanarMixedPhaseSurface(0.4)\nq·µõ‚Å∫·µê = Breeze.Thermodynamics.saturation_specific_humidity(T, œÅ, thermo, mixed_surface)\n\n# output\n0.01128386068542303\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.Thermodynamics.saturation_vapor_pressure-Tuple{Any, Any, Any}","page":"API","title":"Breeze.Thermodynamics.saturation_vapor_pressure","text":"saturation_vapor_pressure(T, thermo, surface) -> Any\n\n\nCompute the saturation vapor pressure p·µõ over a surface labeled Œ≤ (for example, a planar liquid surface, or curved ice surface) using the Clausius-Clapeyron relation,\n\nùñΩp·µõ  ùñΩT = p·µõ ‚Ñí·µù(T)  (R·µõ T^2) \n\nwhere the temperature-dependent latent heat of the surface is ‚Ñí·µù(T).\n\nUsing a model for the latent heat that is linear in temperature, eg\n\n‚Ñí·µù = ‚Ñí·µù‚ÇÄ + Œîc·µù T\n\nwhere ‚Ñí·µù‚ÇÄ  ‚Ñí·µù(T=0) is the latent heat at absolute zero and Œîc·µù  c·µñ·µõ - c·µù  is the constant difference between the vapor specific heat and the specific heat of phase Œ≤.\n\nNote that we typically parameterize the latent heat in terms of a reference temperature T = T·µ£ that is well above absolute zero. In that case, the latent heat is written\n\n‚Ñí·µù = ‚Ñí·µù·µ£ + Œîc·µù (T - T·µ£)\nqquad textand qquad\n‚Ñí·µù‚ÇÄ = ‚Ñí·µù·µ£ - Œîc·µù T·µ£ \n\nIntegrating the Clausius-Clapeyron relation with a temperature-linear latent heat model, from the triple point pressure and temperature (p·µó ≥ T·µó ≥) to pressure p·µõ and temperature T, we obtain\n\nlog(p·µõ  p·µó ≥) = - ‚Ñí·µù‚ÇÄ  (R·µõ T) + ‚Ñí·µù‚ÇÄ  (R·µõ T·µó ≥) + log left (Œîc·µù  R·µõ) (T  T·µó ≥) right \n\nwhich then becomes\n\np·µõ(T) = p·µó ≥ (T  T·µó ≥)^Œîc·µù  R·µõ exp left  (1T·µó ≥ - 1T) ‚Ñí·µù‚ÇÄ  R·µõ right  \n\nnote: Note\nAny reference values for pressure and temperature can be used in principle. The advantage of using reference values at the triple point is that the same values can then be used for both condensation (vapor ‚Üí liquid) and deposition (vapor ‚Üí ice).\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.MoistAirBuoyancies.compute_boussinesq_adjustment_temperature-Union{Tuple{FT}, Tuple{Breeze.Thermodynamics.PotentialTemperatureState{FT}, Any}} where FT","page":"API","title":"Breeze.MoistAirBuoyancies.compute_boussinesq_adjustment_temperature","text":"compute_boussinesq_adjustment_temperature(\n    ùí∞‚ÇÄ::Breeze.Thermodynamics.PotentialTemperatureState{FT},\n    thermo\n) -> Any\n\n\nReturn the temperature T corresponding to thermodynamic equilibrium between the specific humidity and liquid mass fractions of the input thermodynamic state ùí∞‚ÇÄ, wherein the specific humidity is equal to or less than the saturation specific humidity at the given conditions and affiliated with theromdynamic constants thermo.\n\nThe saturation equilibrium temperature satisfies the nonlinear relation\n\nŒ∏ = 1 - ‚ÑíÀ°·µ£ qÀ°  (c·µñ·µê T) T  Œ† \n\nwith ‚ÑíÀ°·µ£ the latent heat at the reference temperature T·µ£, c·µñ·µê the mixture specific heat, Œ† the Exner function, qÀ° = max(0 q·µó - q·µõ) the condensate specific humidity, q·µó is the total specific humidity, and q·µõ is the saturation specific humidity.\n\nThe saturation equilibrium temperature is thus obtained by solving r(T) = 0, where\n\nr(T)  T - Œ∏ Œ† - ‚ÑíÀ°·µ£ qÀ°  c·µñ·µê \n\nSolution of r(T) = 0 is found via the secant method.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.PotentialTemperatureKernelFunction","page":"API","title":"Breeze.AtmosphereModels.PotentialTemperatureKernelFunction","text":"PotentialTemperatureKernel(temperature)\n\nA callable object for diagnosing the potential temperature field, given a temperature field, designed for use as a KernelFunctionOperation in Oceananigans. Follows the pattern used for saturation diagnostics.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.AtmosphereModels.SaturationSpecificHumidityField-Tuple{Any}","page":"API","title":"Breeze.AtmosphereModels.SaturationSpecificHumidityField","text":"SaturationSpecificHumidityField(\n    model\n) -> Field{LX, LY, LZ, O, G, I, D, T, B, Oceananigans.Fields.FieldStatus{Float64}} where {LX, LY, LZ, O, G, I, D, T, B}\n\n\nReturn a field for the saturation specific humidity.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.SaturationSpecificHumidityKernelFunction","page":"API","title":"Breeze.AtmosphereModels.SaturationSpecificHumidityKernelFunction","text":"SaturationSpecificHumidityKernel(temperature)\n\nA callable object for diagnosing the saturation specific humidity field, given a temperature field, designed for use as a KernelFunctionOperation in Oceananigans. Parameters are captured within the kernel struct for GPU friendliness.\n\n\n\n\n\n","category":"type"},{"location":"api/#Breeze.AtmosphereModels.adjust_thermodynamic_state-Tuple{Any, Nothing, Any}","page":"API","title":"Breeze.AtmosphereModels.adjust_thermodynamic_state","text":"adjust_thermodynamic_state(\n    state,\n    scheme::Nothing,\n    thermo\n) -> Any\n\n\nAdjust the thermodynamic state according to the scheme. For example, if scheme isa SaturationAdjustment, then this function will adjust and return a new thermodynamic state given the specifications of the saturation adjustment scheme.\n\nIf a scheme is non-adjusting, we just return state.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.compute_auxiliary_variables!-Tuple{Any}","page":"API","title":"Breeze.AtmosphereModels.compute_auxiliary_variables!","text":"compute_auxiliary_variables!(model)\n\n\nCompute auxiliary model variables:\n\nvelocities from momentum and density (eg u = œÅu  œÅ)\nthermodynamic variables from the prognostic thermodynamic state,\ntemperature T, possibly involving saturation adjustment\nmoist static energy e = œÅe  œÅ\nmoisture mass fraction q·µó = œÅq·µó  œÅ\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.compute_moisture_fractions-Tuple{Any, Any, Any, Any, Nothing, Any, Any, Any}","page":"API","title":"Breeze.AtmosphereModels.compute_moisture_fractions","text":"compute_moisture_fractions(\n    i,\n    j,\n    k,\n    grid,\n    microphysics::Nothing,\n    œÅ,\n    q·µó,\n    Œº\n) -> Breeze.Thermodynamics.MoistureMassFractions\n\n\nBuild and return MoistureMassFractions at (i, j, k) for the given grid, microphysics, microphysical_fields, and total moisture mass fraction q·µó.\n\nDispatch is provided for ::Nothing microphysics here. Specific microphysics schemes may extend this method to provide tailored behavior.\n\nNote: while œÅ and q·µó are scalars, the microphysical fields Œº are NamedTuple of Field. This may be changed in the future.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.diagnose_thermodynamic_state-Tuple{Any, Any, Any, Any, AnelasticFormulation, Vararg{Any, 5}}","page":"API","title":"Breeze.AtmosphereModels.diagnose_thermodynamic_state","text":"diagnose_thermodynamic_state(\n    i,\n    j,\n    k,\n    grid,\n    formulation::AnelasticFormulation,\n    microphysics,\n    microphysical_fields,\n    thermo,\n    energy_density,\n    moisture_density\n) -> Breeze.Thermodynamics.MoistStaticEnergyState\n\n\nReturn MoistStaticEnergyState computed from the prognostic state including energy density, moisture density, and microphysical fields.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.materialize_microphysical_fields-Tuple{Nothing, Any, Any}","page":"API","title":"Breeze.AtmosphereModels.materialize_microphysical_fields","text":"materialize_microphysical_fields(\n    microphysics::Nothing,\n    grid,\n    boundary_conditions\n) -> @NamedTuple{}\n\n\nBuild microphysical fields associated with microphysics on grid and with user defined boundary_conditions.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.maybe_adjust_thermodynamic_state-Tuple{Any, Nothing, Any, Any, Any}","page":"API","title":"Breeze.AtmosphereModels.maybe_adjust_thermodynamic_state","text":"maybe_adjust_thermodynamic_state(\n    state,\n    _::Nothing,\n    microphysical_fields,\n    q·µó,\n    thermo\n) -> Any\n\n\nPossibly apply saturation adjustment. If a microphysics scheme does not invoke saturation adjustment, just return the state unmodified. In contrast to adjust_thermodynamic_state, this function ingests the entire microphysics formulation and the microphysical_fields. This is needed because some microphysics schemes apply saturation adjustment to a subset of the thermodynamic state (for example, omitting precipitating species).\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.microphysical_tendency-Tuple{Any, Any, Any, Any, Nothing, Any, Vararg{Any}}","page":"API","title":"Breeze.AtmosphereModels.microphysical_tendency","text":"microphysical_tendency(\n    i,\n    j,\n    k,\n    grid,\n    microphysics::Nothing,\n    name,\n    args...\n) -> Any\n\n\nReturn the tendency of the microphysical field name associated with microphysics and thermodynamic constants.\n\nTODO: add the function signature when it is stable\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.microphysical_velocities-Tuple{Nothing, Any}","page":"API","title":"Breeze.AtmosphereModels.microphysical_velocities","text":"microphysical_velocities(microphysics::Nothing, name)\n\n\nReturn the microphysical velocities associated with microphysics and name.\n\nMust be either nothing, or a NamedTuple with three components u, v, w.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.prognostic_field_names-Tuple{Nothing}","page":"API","title":"Breeze.AtmosphereModels.prognostic_field_names","text":"prognostic_field_names(_::Nothing) -> Tuple{}\n\n\nReturn tuple() - zero-moment scheme has no prognostic variables.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.update_microphysical_fields!-Tuple{Any, Nothing, Vararg{Any, 7}}","page":"API","title":"Breeze.AtmosphereModels.update_microphysical_fields!","text":"update_microphysical_fields!(\n    microphysical_fields,\n    microphysics::Nothing,\n    i,\n    j,\n    k,\n    grid,\n    density,\n    state,\n    thermo\n)\n\n\nUpdate microphysical fields for microphysics_scheme given the thermodynamic state and thermodynamic parameters.\n\n\n\n\n\n","category":"method"},{"location":"api/#Breeze.AtmosphereModels.‚àá_dot_J·∂ú-Tuple{Any, Any, Any, Any, Vararg{Any}}","page":"API","title":"Breeze.AtmosphereModels.‚àá_dot_J·∂ú","text":"‚àá_dot_J·∂ú(i, j, k, grid, density, closure::AbstractTurbulenceClosure, closure_fields,\n         id, c, clock, model_fields, buoyancy)\n\nReturn the discrete divergence of the dynamic scalar flux J·∂ú = œÅ j·∂ú, where j·∂ú is the \"kinematic scalar flux\", using area-weighted differences divided by cell volume. Similar to Oceananigans' ‚àá_dot_q·∂ú signature with the additional density factor œÅ, where in Oceananigans q·∂ú is the kinematic tracer flux.\n\n\n\n\n\n","category":"method"},{"location":"api/#Oceananigans.TimeSteppers.compute_flux_bc_tendencies!-Tuple{AtmosphereModel}","page":"API","title":"Oceananigans.TimeSteppers.compute_flux_bc_tendencies!","text":"compute_flux_bc_tendencies!(model::AtmosphereModel)\n\n\nApply boundary conditions by adding flux divergences to the right-hand-side.\n\n\n\n\n\n","category":"method"},{"location":"api/#Oceananigans.TimeSteppers.make_pressure_correction!-Tuple{AtmosphereModel{<:AnelasticFormulation}, Any}","page":"API","title":"Oceananigans.TimeSteppers.make_pressure_correction!","text":"make_pressure_correction!(\n    model::AtmosphereModel{<:AnelasticFormulation},\n    Œît\n)\n\n\nUpdate the predictor momentum (œÅu œÅv œÅw) with the non-hydrostatic pressure via\n\n(rhoboldsymbolu)^n+1 = (rhoboldsymbolu)^n - Delta t  rho_r boldsymbolnabla left( alpha_r p_nh right)\n\n\n\n\n\n","category":"method"},{"location":"literated/thermal_bubble/#Thermal-bubble","page":"Thermal bubble","title":"Thermal bubble","text":"This example sets up, runs, and visualizes a \"thermal bubble\" (just a circular region of warm air) rising through a stably-stratified background.\n\nusing Breeze\nusing Oceananigans.Units\nusing Statistics\nusing Printf\nusing CairoMakie","category":"section"},{"location":"literated/thermal_bubble/#A-simple-model-on-a-RectilinearGrid","page":"Thermal bubble","title":"A simple model on a RectilinearGrid","text":"grid = RectilinearGrid(CPU(); size = (128, 128), halo = (5, 5),\n                       x = (-10e3, 10e3), z = (0, 10e3),\n                       topology = (Periodic, Flat, Bounded))\n\nadvection = WENO(order=9)\nmodel = AtmosphereModel(grid; advection)\n\nAtmosphereModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n‚îú‚îÄ‚îÄ grid: 128√ó1√ó128 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 5√ó0√ó5 halo\n‚îú‚îÄ‚îÄ formulation: AnelasticFormulation(p‚ÇÄ=101325.0, Œ∏‚ÇÄ=288.0)\n‚îú‚îÄ‚îÄ timestepper: RungeKutta3TimeStepper\n‚îú‚îÄ‚îÄ advection scheme: WENO{5, Float64, Float32}(order=9)\n‚îú‚îÄ‚îÄ tracers: ()\n‚îú‚îÄ‚îÄ coriolis: Nothing\n‚îî‚îÄ‚îÄ microphysics: Nothing","category":"section"},{"location":"literated/thermal_bubble/#Moist-static-energy-perturbation","page":"Thermal bubble","title":"Moist static energy perturbation","text":"We add a localized potential temperature perturbation that translates into a moist static energy anomaly.\n\nr‚ÇÄ = 2e3\nŒîŒ∏ = 10 # K\nN¬≤ = 1e-6\nŒ∏‚ÇÄ = model.formulation.reference_state.potential_temperature\ng = model.thermodynamics.gravitational_acceleration\n\nfunction Œ∏·µ¢(x, z;\n            x‚ÇÄ = mean(xnodes(grid, Center())),\n            z‚ÇÄ = 0.3*grid.Lz,\n            N¬≤ = N¬≤)\n\n    Œ∏ÃÑ = Œ∏‚ÇÄ * exp(N¬≤ * z / g)\n    r = sqrt((x - x‚ÇÄ)^2 + (z - z‚ÇÄ)^2)\n    Œ∏‚Ä≤ = ŒîŒ∏ * max(0, 1 - r / r‚ÇÄ)\n\n    return Œ∏ÃÑ + Œ∏‚Ä≤\nend\n\nset!(model, Œ∏ = Œ∏·µ¢)\n\nœÅe = model.energy_density\nœÅE = Field(Average(œÅe, dims=1))\nœÅe‚Ä≤ = Field(œÅe - œÅE)\n\n128√ó1√ó128 Field{Center, Center, Center} on RectilinearGrid on CPU\n‚îú‚îÄ‚îÄ grid: 128√ó1√ó128 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 5√ó0√ó5 halo\n‚îú‚îÄ‚îÄ boundary conditions: FieldBoundaryConditions\n‚îÇ   ‚îî‚îÄ‚îÄ west: Periodic, east: Periodic, south: Nothing, north: Nothing, bottom: ZeroFlux, top: ZeroFlux, immersed: Nothing\n‚îú‚îÄ‚îÄ operand: BinaryOperation at (Center, Center, Center)\n‚îú‚îÄ‚îÄ status: time=0.0\n‚îî‚îÄ‚îÄ data: 138√ó1√ó138 OffsetArray(::Array{Float64, 3}, -4:133, 1:1, -4:133) with eltype Float64 with indices -4:133√ó1:1√ó-4:133\n    ‚îî‚îÄ‚îÄ max=7277.39, min=-849.551, mean=4.93827e-13","category":"section"},{"location":"literated/thermal_bubble/#Initial-energy-perturbation-visualization","page":"Thermal bubble","title":"Initial energy perturbation visualization","text":"Plot the initial moist static energy perturbation to ensure the bubble looks as expected.\n\nfig = Figure()\nax = Axis(fig[1, 1], aspect=2, xlabel=\"x (m)\", ylabel=\"z (m)\", title=\"Initial energy perturbation œÅe‚Ä≤ (J / kg)\")\nhm = heatmap!(ax, œÅe‚Ä≤)\nColorbar(fig[1, 2], hm, label = \"œÅe‚Ä≤ (J/kg)\")\nfig\n\n(Image: )","category":"section"},{"location":"literated/thermal_bubble/#Simulation-rising","page":"Thermal bubble","title":"Simulation rising","text":"simulation = Simulation(model; Œît=2, stop_time=25minutes)\nconjure_time_step_wizard!(simulation, cfl=0.7)\n\nfunction progress(sim)\n    œÅe = sim.model.energy_density\n    u, v, w = sim.model.velocities\n\n    msg = @sprintf(\"Iter: %d, t: %s, Œît: %s, extrema(œÅe): (%.2f, %.2f) J/kg, max|u|: %.2f m/s, max|w|: %.2f m/s\",\n                   iteration(sim), prettytime(sim), prettytime(sim.Œît),\n                   minimum(œÅe), maximum(œÅe),\n                   maximum(abs, u), maximum(abs, w))\n\n    @info msg\n    return nothing\nend\n\nadd_callback!(simulation, progress, TimeInterval(1minute))\n\nu, v, w = model.velocities\nT = model.temperature\n\noutputs = merge(model.velocities, model.tracers, (; œÅe‚Ä≤, œÅe, T))\n\nfilename = \"thermal_bubble.jld2\"\nwriter = JLD2Writer(model, outputs; filename,\n                    schedule = TimeInterval(10seconds),\n                    overwrite_existing = true)\n\nsimulation.output_writers[:jld2] = writer\n\nrun!(simulation)\n\n[ Info: Initializing simulation...\n[ Info: Iter: 0, t: 0 seconds, Œît: 2.200 seconds, extrema(œÅe): (126699.03, 353638.32) J/kg, max|u|: 0.00 m/s, max|w|: 0.00 m/s\n[ Info:     ... simulation initialization complete (10.095 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (2.797 seconds).\n[ Info: Iter: 28, t: 1 minute, Œît: 2.662 seconds, extrema(œÅe): (126699.03, 353636.24) J/kg, max|u|: 3.61 m/s, max|w|: 8.96 m/s\n[ Info: Iter: 52, t: 2 minutes, Œît: 3.210 seconds, extrema(œÅe): (126699.18, 353629.79) J/kg, max|u|: 7.38 m/s, max|w|: 17.13 m/s\n[ Info: Iter: 76, t: 3 minutes, Œît: 2.553 seconds, extrema(œÅe): (126700.13, 353618.53) J/kg, max|u|: 11.35 m/s, max|w|: 22.16 m/s\n[ Info: Iter: 105, t: 4 minutes, Œît: 2.185 seconds, extrema(œÅe): (126704.40, 353602.08) J/kg, max|u|: 15.13 m/s, max|w|: 25.34 m/s\n[ Info: Iter: 138, t: 5 minutes, Œît: 1.875 seconds, extrema(œÅe): (126718.44, 353580.70) J/kg, max|u|: 18.59 m/s, max|w|: 29.98 m/s\n[ Info: Iter: 176, t: 6 minutes, Œît: 1.623 seconds, extrema(œÅe): (126757.11, 353555.20) J/kg, max|u|: 22.04 m/s, max|w|: 33.58 m/s\n[ Info: Iter: 218, t: 7 minutes, Œît: 1.529 seconds, extrema(œÅe): (126812.98, 353526.43) J/kg, max|u|: 25.06 m/s, max|w|: 33.91 m/s\n[ Info: Iter: 260, t: 8 minutes, Œît: 1.403 seconds, extrema(œÅe): (126867.08, 353495.11) J/kg, max|u|: 30.44 m/s, max|w|: 35.05 m/s\n[ Info: Iter: 308, t: 9 minutes, Œît: 1.390 seconds, extrema(œÅe): (126940.81, 353461.99) J/kg, max|u|: 38.19 m/s, max|w|: 32.49 m/s\n[ Info: Iter: 356, t: 10 minutes, Œît: 1.399 seconds, extrema(œÅe): (126989.73, 353432.37) J/kg, max|u|: 43.38 m/s, max|w|: 28.93 m/s\n[ Info: Iter: 400, t: 11 minutes, Œît: 1.522 seconds, extrema(œÅe): (126990.87, 353419.92) J/kg, max|u|: 45.38 m/s, max|w|: 25.84 m/s\n[ Info: Iter: 444, t: 12 minutes, Œît: 1.312 seconds, extrema(œÅe): (127047.22, 353406.81) J/kg, max|u|: 36.94 m/s, max|w|: 30.04 m/s\n[ Info: Iter: 492, t: 13 minutes, Œît: 1.305 seconds, extrema(œÅe): (128053.30, 353393.07) J/kg, max|u|: 34.40 m/s, max|w|: 40.97 m/s\n[ Info: Iter: 547, t: 14 minutes, Œît: 1.056 seconds, extrema(œÅe): (128369.72, 353378.49) J/kg, max|u|: 32.00 m/s, max|w|: 48.31 m/s\n[ Info: Iter: 609, t: 15 minutes, Œît: 1.036 seconds, extrema(œÅe): (128640.91, 353362.76) J/kg, max|u|: 33.47 m/s, max|w|: 49.98 m/s\n[ Info: Iter: 664, t: 16 minutes, Œît: 1.155 seconds, extrema(œÅe): (128150.43, 353345.63) J/kg, max|u|: 30.15 m/s, max|w|: 40.87 m/s\n[ Info: Iter: 722, t: 17 minutes, Œît: 1.035 seconds, extrema(œÅe): (128057.41, 353323.16) J/kg, max|u|: 27.02 m/s, max|w|: 47.65 m/s\n[ Info: Iter: 782, t: 18 minutes, Œît: 1.083 seconds, extrema(œÅe): (127958.06, 353291.97) J/kg, max|u|: 26.36 m/s, max|w|: 45.59 m/s\n[ Info: Iter: 838, t: 19 minutes, Œît: 1.191 seconds, extrema(œÅe): (127924.22, 353249.31) J/kg, max|u|: 29.08 m/s, max|w|: 39.26 m/s\n[ Info: Iter: 892, t: 20 minutes, Œît: 1.168 seconds, extrema(œÅe): (127953.45, 353202.66) J/kg, max|u|: 27.55 m/s, max|w|: 39.30 m/s\n[ Info: Iter: 946, t: 21 minutes, Œît: 1.268 seconds, extrema(œÅe): (128019.36, 353162.86) J/kg, max|u|: 29.28 m/s, max|w|: 37.69 m/s\n[ Info: Iter: 994, t: 22 minutes, Œît: 1.367 seconds, extrema(œÅe): (128057.61, 353133.49) J/kg, max|u|: 30.42 m/s, max|w|: 38.26 m/s\n[ Info: Iter: 1042, t: 23 minutes, Œît: 1.350 seconds, extrema(œÅe): (127643.41, 353116.70) J/kg, max|u|: 30.23 m/s, max|w|: 36.48 m/s\n[ Info: Iter: 1089, t: 24 minutes, Œît: 1.433 seconds, extrema(œÅe): (127388.85, 353537.80) J/kg, max|u|: 30.49 m/s, max|w|: 33.77 m/s\n[ Info: Simulation is stopping after running for 1.480 minutes.\n[ Info: Simulation time 25 minutes equals or exceeds stop time 25 minutes.\n[ Info: Iter: 1137, t: 25 minutes, Œît: 1.388 seconds, extrema(œÅe): (127206.45, 354045.44) J/kg, max|u|: 32.03 m/s, max|w|: 34.00 m/s\n","category":"section"},{"location":"literated/thermal_bubble/#Visualization","page":"Thermal bubble","title":"Visualization","text":"Visualize the moist static energy perturbation and the vertical velocity through time and create an animation.\n\n@info \"Creating visualization...\"\n\nœÅe‚Ä≤t = FieldTimeSeries(filename, \"œÅe‚Ä≤\")\nwt = FieldTimeSeries(filename, \"w\")\n\ntimes = œÅe‚Ä≤t.times\nNt = length(œÅe‚Ä≤t)\n\nfig = Figure(size = (800, 800), fontsize = 12)\naxœÅ = Axis(fig[1, 1], aspect=2, xlabel=\"x (m)\", ylabel=\"z (m)\", title=\"Energy perturbation œÅe‚Ä≤ (J / kg)\")\naxw = Axis(fig[2, 1], aspect=2, xlabel=\"x (m)\", ylabel=\"z (m)\", title=\"Vertical velocity w (m / s)\")\n\nn = Observable(Nt)\n\nœÅe‚Ä≤n = @lift œÅe‚Ä≤t[$n]\nwn = @lift wt[$n]\n\ntitle = @lift \"Thermal bubble evolution ‚Äî t = $(prettytime(times[$n]))\"\nfig[0, :] = Label(fig, title, fontsize = 16, tellwidth = false)\n\nœÅe‚Ä≤_range = (minimum(œÅe‚Ä≤t), maximum(œÅe‚Ä≤t))\nw_range = maximum(abs, wt)\n\nhmœÅ = heatmap!(axœÅ, œÅe‚Ä≤n, colorrange = œÅe‚Ä≤_range, colormap = :balance)\nhmw = heatmap!(axw, wn, colorrange = (-w_range, w_range), colormap = :balance)\n\nColorbar(fig[1, 2], hmœÅ, label = \"œÅe‚Ä≤ (J/kg)\", vertical = true)\nColorbar(fig[2, 2], hmw, label = \"w (m/s)\", vertical = true)\n\nCairoMakie.record(fig, \"thermal_bubble.mp4\", 1:Nt, framerate = 12) do nn\n    n[] = nn\nend\n\n[ Info: Creating visualization...\n\n\n(Image: )\n\n\n\nThis page was generated using Literate.jl.","category":"section"},{"location":"dycore_equations_algorithms/#Dycore-section","page":"Dycore equations and algorithms","title":"Dycore equations and algorithms","text":"This section summarizes the governing equations behind Breeze‚Äôs atmospheric dynamics and the anelastic formulation used by AtmosphereModel, following the thermodynamically consistent framework of Pauluis (2008).\n\nWe begin with the compressible Navier-Stokes momentum equations and reduce them to an anelastic, conservative form. We then introduce the moist static energy equation and outline the time-discretized pressure correction used to enforce the anelastic constraint.","category":"section"},{"location":"dycore_equations_algorithms/#Compressible-momentum-equations","page":"Dycore equations and algorithms","title":"Compressible momentum equations","text":"Let œÅ denote density, boldsymbolu velocity, p pressure, boldsymbolf non-pressure body forces (e.g., Coriolis), and boldsymboltau the kinematic (per-mass) subgrid/viscous stresses. We denote the corresponding dynamic (per-volume) stresses by boldsymbolmathcalT = œÅ  boldsymboltau. With gravity - g hatboldsymbolz, the inviscid compressible equations in flux form are\n\nbeginaligned\ntextMass  partial_t œÅ + boldsymbolnabla cdot (œÅ boldsymbolu) = 0 \ntextMomentum  partial_t(œÅ boldsymbolu) + boldsymbolnabla cdot (œÅ boldsymbolu boldsymbolu) + boldsymbolnabla p = - œÅ g hatboldsymbolz + œÅ boldsymbolf + boldsymbolnabla cdot boldsymbolmathcalT \nendaligned\n\nNotation boldsymbolnabla cdot (œÅ boldsymbolu boldsymbolu) above denotes a vector whose components are boldsymbolnabla cdot (œÅ boldsymbolu boldsymbolu)_i = boldsymbolnabla cdot (œÅ u_i boldsymbolu).\n\nFor moist flows we also track total water (vapor + condensates) via\n\npartial_t(œÅ q^t) + boldsymbolnabla cdot (œÅ q^t boldsymbolu) = S_q \n\nwhere q^t is total specific humidity and S_q accounts for sources/sinks from microphysics and boundary fluxes.\n\nThermodynamic relations (mixture gas constant R^m, heat capacity c^pm, Exner function, etc.) are summarized in the Thermodynamics section.","category":"section"},{"location":"dycore_equations_algorithms/#Anelastic-approximation","page":"Dycore equations and algorithms","title":"Anelastic approximation","text":"To filter acoustic waves while retaining compressibility effects in buoyancy and thermodynamics, we linearize about a hydrostatic, horizontally uniform reference state (p·µ£(z) œÅ·µ£(z)) with constant reference potential temperature Œ∏·µ£. The key assumptions are\n\nSmall Mach number and small relative density perturbations except in buoyancy.\nHydrostatic reference balance: partial_z p·µ£ = -œÅ·µ£ g.\nMass flux divergence constraint: boldsymbolnabla cdot (œÅ·µ£boldsymbolu) = 0.\n\nDefine the specific volume of moist air and its reference value as\n\nŒ± = fracR^m Tp·µ£  qquad Œ±·µ£ = fracR^d Œ∏·µ£p·µ£ \n\nwhere R^m is the mixture gas constant and R^d is the dry-air gas constant. The buoyancy appearing in the vertical momentum is\n\nb  g fracŒ± - Œ±·µ£Œ±·µ£ ","category":"section"},{"location":"dycore_equations_algorithms/#Conservative-anelastic-system","page":"Dycore equations and algorithms","title":"Conservative anelastic system","text":"With œÅ·µ£(z) fixed by the reference state, the prognostic equations advanced in Breeze are written in conservative form for the œÅ·µ£-weighted fields:\n\nContinuity (constraint):\n\nboldsymbolnabla cdot (œÅ·µ£ boldsymbolu) = 0 \n\nMomentum:\n\npartial_t(œÅ·µ£ boldsymbolu) + boldsymbolnabla cdot (œÅ·µ£ boldsymbolu boldsymbolu) = - œÅ·µ£ boldsymbolnabla phi + œÅ·µ£  b hatboldsymbolz + œÅ·µ£ boldsymbolf + boldsymbolnabla cdot boldsymbolmathcalT \n\nwhere phi is a nonhydrostatic pressure correction potential defined by the projection step (see below). Pressure is decomposed as p = p·µ£(z) + p_h(x y z t) + p_n, where p_h is a hydrostatic anomaly (obeying partial_z p_h = -œÅ·µ£ b) and p_n is the nonhydrostatic component responsible for enforcing the anelastic constraint. In the discrete formulation used here, phi coincides with the pressure correction variable.\n\nTotal water:\n\npartial_t(œÅ·µ£ q^t) + boldsymbolnabla cdot (œÅ·µ£ q^t boldsymbolu) = S_q ","category":"section"},{"location":"dycore_equations_algorithms/#Moist-static-energy","page":"Dycore equations and algorithms","title":"Moist static energy","text":"Breeze advances a conservative moist static energy density\n\nœÅ·µ£ e  œÅ·µ£ left ( c^pm T + g z - mathscrL^l_r q^l - mathscrL^i_r q^i right )\n\nwhere c^p m is the mixture heat capacity, T is temperature, g is gravitational acceleration, z is height, mathscrL^l_r is the latent heat of condensation (vapor to liquid) at the energy reference temperature, and  mathscrL^i_r is the latent heat of deposition (vapor to ice) at the energy reference temperature,\n\nAccording to Pauluis (2008), the moist static energy obeys \n\npartial_t(œÅ·µ£ e) + boldsymbolnabla cdot (œÅ·µ£ e boldsymbolu) = œÅ·µ£ w b + S_e \n\nwith vertical velocity w, buoyancy b as above, and S_e including microphysical and external energy sources/sinks. The œÅ·µ£ w b term is the buoyancy flux that links the energy and momentum budgets in the anelastic limit.\n\nThermodynamic closures needed for R^m, c^pm and the Exner function Œ† = (p·µ£  p_0)^R^m  c^pm are given in Thermodynamics section.","category":"section"},{"location":"dycore_equations_algorithms/#Time-discretization-and-pressure-correction","page":"Dycore equations and algorithms","title":"Time discretization and pressure correction","text":"Breeze uses an explicit multi-stage time integrator for advection, Coriolis, buoyancy, forcing, and tracer terms, coupled with a projection step to enforce the anelastic constraint at each substep. Denote the predicted momentum by widetilde(œÅ·µ£ boldsymbolu). The projection is\n\nSolve the variable-coefficient Poisson problem for the pressure correction potential phi:\nboldsymbolnabla cdot big( œÅ·µ£  boldsymbolnabla phi big) = frac1Œît  boldsymbolnabla cdot widetilde(œÅ·µ£ boldsymbolu) \nwith periodic lateral boundaries and homogeneous Neumann boundary conditions in z.\nUpdate momentum to enforce boldsymbolnabla cdot (œÅ·µ£ boldsymbolu^n+1) = 0:\nœÅ·µ£ boldsymbolu^n+1 = widetilde(œÅ·µ£ boldsymbolu) - Œît  œÅ·µ£ boldsymbolnabla phi \n\nIn Breeze this projection is implemented as a Fourier‚Äìtridiagonal solve in the vertical with variable œÅ·µ£(z), aligning with the hydrostatic reference state. The hydrostatic pressure anomaly p_h can be obtained diagnostically by vertical integration of buoyancy and used when desired to separate hydrostatic and nonhydrostatic pressure effects.","category":"section"},{"location":"dycore_equations_algorithms/#Symbols-and-closures-used-here","page":"Dycore equations and algorithms","title":"Symbols and closures used here","text":"œÅ·µ£(z), p·µ£(z): Reference density and pressure satisfying hydrostatic balance for a constant Œ∏·µ£.\nŒ± = R^m T  p·µ£, Œ±·µ£ = R^d Œ∏·µ£  p·µ£: Specific volume and its reference value.\nb = g (Œ± - Œ±·µ£)  Œ±·µ£: Buoyancy.\ne = c^pd  Œ∏: Energy variable used for moist static energy in the conservative equation.\nq^t: Total specific humidity (vapor + condensates).\nphi: Nonhydrostatic pressure correction potential used by the projection.\n\nDiffusion and turbulence closure notation:\n\nboldsymboltau: Kinematic (per-mass) subgrid/viscous stress tensor returned by Oceananigans closures.\nboldsymbolmathcalT = œÅ·µ£  boldsymboltau: Dynamic (per-volume) stress used in the anelastic momentum equation; Breeze computes flux divergences as boldsymbolnablacdot boldsymbolmathcalT.\n\nSee Thermodynamics section for definitions of R^m(q), c^pm(q), and Œ†.","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Cloudy-Kelvin-Helmholtz-instability","page":"Cloudy Kelvin-Helmholtz instability","title":"Cloudy Kelvin-Helmholtz instability","text":"This example sets up a two-dimensional (x‚Äìz) Kelvin‚ÄìHelmholtz instability in a moist, stably stratified atmosphere.\n\nThe configuration is intentionally simple but reasonably \"meteorological\":\n\nWe impose horizontal wind U(z) with a shear layer.\nWe impose a stably stratified potential temperature profile Œ∏(z) with a specified dry Brunt‚ÄìV√§is√§l√§ frequency N.\nWe embed a Gaussian moisture layer q(z) centered on the shear layer.\n\nAs the shear layer rolls up, the moist layer is advected and deformed, producing billow-like patterns reminiscent of observed \"wave clouds\". Breeze encapsulates much of this thermodynamics for us via the AtmosphereModel and saturation adjustment.\n\nusing Breeze\nusing Oceananigans.Units\nusing CairoMakie\nusing Printf","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Domain-and-grid","page":"Cloudy Kelvin-Helmholtz instability","title":"Domain and grid","text":"We use a 2D x‚Äìz slice with periodic boundaries in x and rigid, impermeable boundaries at the top and bottom.\n\nGrid resolution is modest but enough to clearly resolve the Kelvin-Helmholtz billows and rolled-up moisture filament.\n\nNx = 384   # horizontal resolution\nNz = 128   # vertical resolution\n\nLx = 10e3  # domain length\nLz =  3e3  # domain height\n\ngrid = RectilinearGrid(; size = (Nx, Nz), x = (0, Lx), z = (0, Lz),\n                         topology = (Periodic, Flat, Bounded))\n\n384√ó1√ó128 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3√ó0√ó3 halo\n‚îú‚îÄ‚îÄ Periodic x ‚àà [0.0, 10000.0) regularly spaced with Œîx=26.0417\n‚îú‚îÄ‚îÄ Flat y                      \n‚îî‚îÄ‚îÄ Bounded  z ‚àà [0.0, 3000.0]  regularly spaced with Œîz=23.4375","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Model-and-microphysics","page":"Cloudy Kelvin-Helmholtz instability","title":"Model and microphysics","text":"We construct the AtmosphereModel model with saturation adjustment microphysics.\n\nmicrophysics = SaturationAdjustment(equilibrium=WarmPhaseEquilibrium())\nmodel = AtmosphereModel(grid; advection=WENO(order=5), microphysics)\n\nAtmosphereModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n‚îú‚îÄ‚îÄ grid: 384√ó1√ó128 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3√ó0√ó3 halo\n‚îú‚îÄ‚îÄ formulation: AnelasticFormulation(p‚ÇÄ=101325.0, Œ∏‚ÇÄ=288.0)\n‚îú‚îÄ‚îÄ timestepper: RungeKutta3TimeStepper\n‚îú‚îÄ‚îÄ advection scheme: WENO{3, Float64, Float32}(order=5)\n‚îú‚îÄ‚îÄ tracers: ()\n‚îú‚îÄ‚îÄ coriolis: Nothing\n‚îî‚îÄ‚îÄ microphysics: SaturationAdjustment","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Background-thermodynamic-state","page":"Cloudy Kelvin-Helmholtz instability","title":"Background thermodynamic state","text":"We set a reference potential temperature Œ∏‚ÇÄ and a linear Œ∏ gradient that corresponds to a desired dry Brunt‚ÄìV√§is√§l√§ frequency N. For a dry atmosphere,\n\nN¬≤ = fracgŒ∏‚ÇÄ fracŒ∏z \n\nWe initialize the potential temperature that gives constant Brunt‚ÄìV√§is√§l√§ frequency, representative of mid-tropospheric stability. The (dry) Brunt‚ÄìV√§is√§l√§ frequency is\n\nN¬≤ = fracgŒ∏ fracŒ∏z\n\nand thus, for constant N¬≤ the above implies Œ∏ = Œ∏‚ÇÄ exp(N¬≤ z  g).\n\nthermo = ThermodynamicConstants()\ng = thermo.gravitational_acceleration\nŒ∏‚ÇÄ = model.formulation.reference_state.potential_temperature\nN = 0.01                  # target dry Brunt‚ÄìV√§is√§l√§ frequency (s‚Åª¬π)\nŒ∏·µá(z) = Œ∏‚ÇÄ * exp(N^2 * z / g)\n\nŒ∏·µá (generic function with 1 method)","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Shear-and-moisture-profiles","page":"Cloudy Kelvin-Helmholtz instability","title":"Shear and moisture profiles","text":"We want:\n\nA shear layer centered at height z‚ÇÄ with the zonal flow transitioning from a lower speed U_rm bot to an upper speed U_rm top.\nA moist layer centered at the same height with a Gaussian profile.\n\nThe above  mimics a moist, stably stratified layer embedded in stronger flow above and weaker flow below.\n\nFirst, we set up the shear layer using a tanh profile:\n\nz‚ÇÄ    = 1e3     # center of shear & moist layer (m)\nŒîz·∂∏   = 150     # shear layer half-thickness (m)\nU_top = 25      # upper-layer wind (m/s)\nU_bot =  5      # lower-layer wind (m/s)\nu·µá(z) = U_bot + (U_top - U_bot) * (1 + tanh((z - z‚ÇÄ) / Œîz·∂∏)) / 2\n\nu·µá (generic function with 1 method)\n\nFor the moisture layer, we use a Gaussian in z centered at z‚ÇÄ:\n\nq_max = 0.012  # peak specific humidity (kg/kg)\nŒîz_q = 200     # moist layer half-width (m)\nq·µá(z) = q_max * exp(-(z - z‚ÇÄ)^2 / 2Œîz_q^2)\n\nq·µá (generic function with 1 method)","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#The-Kelvin-Helmholtz-instability","page":"Cloudy Kelvin-Helmholtz instability","title":"The Kelvin-Helmholtz instability","text":"The Miles‚ÄìHoward criterion tells us that Kelvin‚ÄìHelmholtz instability occurs where the Richardson number,\n\nRi = fracN¬≤(u·µáz)¬≤\n\nis less than 1/4 (Miles, 1961; Howard, 1961). With the parameters chosen above this is the case.\n\nLet's plot the initial state as well as the Richardson number.\n\nz = znodes(grid, Center())\n\ndudz = @. (U_top - U_bot) * sech((z - z‚ÇÄ) / Œîz·∂∏)^2 / 2Œîz·∂∏\nRi = N^2 ./ dudz.^2\n\nusing CairoMakie\n\nfig = Figure(size=(800, 500))\n\naxu = Axis(fig[1, 1], xlabel = \"u·µá (m/s)\", ylabel = \"z (m)\", title = \"Zonal velocity\")\naxq = Axis(fig[1, 2], xlabel = \"q·µá (kg/kg)\", title=\"Total liquid\")\naxŒ∏ = Axis(fig[1, 3], xlabel = \"Œ∏·µá (K)\", title=\"Potential temperature\")\naxR = Axis(fig[1, 4], xlabel = \"Ri\", ylabel=\"z (m)\", title=\"Richardson number\")\n\nlines!(axu, u·µá.(z), z)\nlines!(axq, q·µá.(z), z)\nlines!(axŒ∏, Œ∏·µá.(z), z)\nlines!(axR, Ri, z)\nlines!(axR, [1/4, 1/4], [0, Lz], linestyle = :dash, color = :black)\nxlims!(axR, 0, 0.8)\naxR.xticks = 0:0.25:1\n\nfor ax in (axq, axŒ∏, axR)\n    ax.yticksvisible = false\n    ax.yticklabelsvisible = false\n    ax.ylabelvisible = false\nend\n\nfig\n\n(Image: )","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Define-initial-conditions","page":"Cloudy Kelvin-Helmholtz instability","title":"Define initial conditions","text":"We initialize the model via Oceananigans set!, adding also a bit of random noise.\n\nŒ¥Œ∏ = 0.01\nŒ¥u = 1e-3\nŒ¥q = 0.05 * q_max\n\nŒ∏·µ¢(x, z) = Œ∏·µá(z) + Œ¥Œ∏ * rand()\nq·µó·µ¢(x, z) = q·µá(z) + Œ¥q * rand()\nu·µ¢(x, z) = u·µá(z) + Œ¥u * rand()\n\nset!(model; u=u·µ¢, q·µó=q·µó·µ¢, Œ∏=Œ∏·µ¢)","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Set-up-and-run-the-simulation","page":"Cloudy Kelvin-Helmholtz instability","title":"Set up and run the simulation","text":"We construct a simulation and use the time-step wizard to keep the CFL number under control.\n\nstop_time = 12minutes   # total simulation time\nsimulation = Simulation(model; Œît=1, stop_time)\nconjure_time_step_wizard!(simulation; cfl = 0.7)\n\nWe also add a progress callback:\n\nfunction progress(sim)\n    u, v, w = model.velocities\n    max_w = maximum(abs, w)\n    @info @sprintf(\"iteration: %d, time: %s, Œît: %s, max|w|: %.2e m/s\",\n                   iteration(sim), prettytime(sim), prettytime(sim.Œît), max_w)\n    return nothing\nend\n\nadd_callback!(simulation, progress, TimeInterval(1minute))","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Output","page":"Cloudy Kelvin-Helmholtz instability","title":"Output","text":"We save the model velocities, the cross-stream component of vorticity, Œæ = _z u - _x w, the potential temperatures and the specific humidities (vapour, liquid, ice).\n\nu, v, w = model.velocities\nŒæ = ‚àÇz(u) - ‚àÇx(w)\nŒ∏ = PotentialTemperatureField(model)\noutputs = merge(model.velocities, model.microphysical_fields, (; Œæ, Œ∏))\n\nfilename = \"wave_clouds.jld2\"\n\noutput_writer = JLD2Writer(model, outputs;\n                           filename,\n                           schedule = TimeInterval(4),\n                           overwrite_existing = true)\n\nsimulation.output_writers[:fields] = output_writer\n\nJLD2Writer scheduled on TimeInterval(4 seconds):\n‚îú‚îÄ‚îÄ filepath: wave_clouds.jld2\n‚îú‚îÄ‚îÄ 7 outputs: (u, v, w, q·µõ, qÀ°, Œæ, Œ∏)\n‚îú‚îÄ‚îÄ array_type: Array{Float32}\n‚îú‚îÄ‚îÄ including: [:grid]\n‚îú‚îÄ‚îÄ file_splitting: NoFileSplitting\n‚îî‚îÄ‚îÄ file size: 56.5 KiB","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Run!","page":"Cloudy Kelvin-Helmholtz instability","title":"Run!","text":"Now we are ready to run the simulation.\n\nrun!(simulation)\n\n[ Info: Initializing simulation...\n[ Info: iteration: 0, time: 0 seconds, Œît: 729.130 ms, max|w|: 4.04e-04 m/s\n[ Info:     ... simulation initialization complete (3.411 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (2.703 seconds).\n[ Info: iteration: 90, time: 1 minute, Œît: 728.141 ms, max|w|: 1.93e-01 m/s\n[ Info: iteration: 180, time: 2 minutes, Œît: 727.568 ms, max|w|: 5.82e-01 m/s\n[ Info: iteration: 270, time: 3 minutes, Œît: 690.738 ms, max|w|: 1.39e+00 m/s\n[ Info: iteration: 367, time: 4 minutes, Œît: 651.702 ms, max|w|: 1.71e+00 m/s\n[ Info: iteration: 472, time: 5 minutes, Œît: 611.941 ms, max|w|: 2.35e+00 m/s\n[ Info: iteration: 577, time: 6 minutes, Œît: 594.388 ms, max|w|: 2.75e+00 m/s\n[ Info: iteration: 682, time: 7 minutes, Œît: 579.142 ms, max|w|: 3.97e+00 m/s\n[ Info: iteration: 798, time: 8 minutes, Œît: 538.481 ms, max|w|: 7.50e+00 m/s\n[ Info: iteration: 920, time: 9 minutes, Œît: 484.793 ms, max|w|: 1.09e+01 m/s\n[ Info: iteration: 1055, time: 10 minutes, Œît: 449.703 ms, max|w|: 1.28e+01 m/s\n[ Info: iteration: 1200, time: 11 minutes, Œît: 431.929 ms, max|w|: 1.71e+01 m/s\n[ Info: Simulation is stopping after running for 2.701 minutes.\n[ Info: Simulation time 12 minutes equals or exceeds stop time 12 minutes.\n[ Info: iteration: 1338, time: 12 minutes, Œît: 458.018 ms, max|w|: 1.41e+01 m/s\n","category":"section"},{"location":"literated/cloudy_kelvin_helmholtz/#Read-output-and-visualize","page":"Cloudy Kelvin-Helmholtz instability","title":"Read output and visualize","text":"We load the saved output as Oceananigans' FieldTimeSeries\n\nŒæt = FieldTimeSeries(filename, \"Œæ\")\nŒ∏t = FieldTimeSeries(filename, \"Œ∏\")\nqÀ°t = FieldTimeSeries(filename, \"qÀ°\")\n\ntimes = Œæt.times\nNt = length(Œæt)\n\n181\n\nand then use CairoMakie to plot and animate the output.\n\nn = Observable(Nt)\n\nŒæn = @lift Œæt[$n]\nŒ∏n = @lift Œ∏t[$n]\nqÀ°n = @lift qÀ°t[$n]\n\nfig = Figure(size=(800, 800), fontsize=14)\n\naxŒæ = Axis(fig[1, 1], ylabel=\"z (m)\", title = \"Vorticity\", titlesize = 20)\naxl = Axis(fig[2, 1], ylabel=\"z (m)\", title = \"Liquid mass fraction\", titlesize = 20)\naxŒ∏ = Axis(fig[3, 1], xlabel=\"x (m)\", ylabel=\"z (m)\", title = \"Potential temperature\", titlesize = 20)\n\nhmŒæ = heatmap!(axŒæ, Œæn, colormap = :balance, colorrange = (-0.25, 0.25))\nhml = heatmap!(axl, qÀ°n, colormap = Reverse(:Blues_4), colorrange = (0, 0.003))\nhmŒ∏ = heatmap!(axŒ∏, Œ∏n, colormap = :thermal, colorrange = extrema(Œ∏t))\n\nColorbar(fig[1, 2], hmŒæ, label = \"s‚Åª¬π\", vertical = true)\nColorbar(fig[2, 2], hml, label = \"kg/kg\", vertical = true)\nColorbar(fig[3, 2], hmŒ∏, label = \"Œö\", vertical = true)\n\nfig\n\n(Image: )\n\nWe can also make a movie:\n\nCairoMakie.record(fig, \"wave_clouds.mp4\", 1:Nt, framerate = 12) do nn\n    n[] = nn\nend\n\n(Image: )\n\n\n\nThis page was generated using Literate.jl.","category":"section"},{"location":"microphysics/microphysics_overview/#section:microphysics-overview","page":"Overview","title":"Microphysics","text":"In atmospheric modeling, \"microphysics\" largely overlaps with \"cloud physics\" and concerns the formation, development, and precipitation of clouds. More generally, \"microphysics\" encompasses panoply of physical processes associated with (i) the conversion of water between vapor, liquid, and ice phases, and (ii) the interaction and transformation of \"cloud particles\", which include droplets, ice particles, and aerosols. For example: microphysical processes include droplet nucleation on aerosol particles; liquid freezing and vapor solidification; chemical and humidity-based transformations of aerosol particles; the agglomeration of ice particles into snowflakes; collisions and breakup of falling droplets (rain); collision between ice particles and droplets or wholesale freezing of droplets to form hail (e.g. Straka (2009)).\n\nBreeze microphysics is nascent and under active development. Breeze aims to eventually provide a wide range of microphysical models, ranging from simple warm-phase saturation adjustment, to the bulk schemes provided by the Climate Modeling Alliance's CloudMicrophysics.jl, to superdroplet schemes, to spectral bin schemes that include a spectrum of droplet sizes, ice particle shapes and aerosol types.","category":"section"},{"location":"#Breeze.jl","page":"Home","title":"Breeze.jl","text":"Fast, friendly atmosphere simulations on CPUs and GPUs.\n\nBreeze provides software for flexible software package for finite-volume atmosphere simulations on CPUs and GPUs, based on Oceananigans. Like Oceananigans, it provides a radically productive user interface that makes simple simulations easy, and complex, creative simulations possible.","category":"section"},{"location":"#Features","page":"Home","title":"Features","text":"Breeze provides two ways to simulate moist atmospheres:\n\nAn AtmosphereModel which currently supports anelastic approximation following Pauluis (2008):\nAtmosphereModel has simple warm-phase saturation adjustment microphysics\nAtmosphereModel is being rapidly developed and changes day-to-day!\nA roadmap is coming soon, and will include radiation, bulk, bin, and superdroplet microphysics, a fully compressible formulation, and more \nA MoistAirBuoyancy buoyancy implementation that can be used with Oceananigans' NonhydrostaticModel to simulate atmospheric flows with the Boussinesq approximation:\nMoistAirBuoyancy includes a warm-phase saturation adjustment implementation\nNote that our attention is focused on AtmosphereModel!","category":"section"},{"location":"#Installation","page":"Home","title":"Installation","text":"To use Breeze, install directly from GitHub:\n\nusing Pkg\nPkg.add(\"https://github.com/NumericalEarth/Breeze.jl.git\")","category":"section"},{"location":"#Quick-Start","page":"Home","title":"Quick Start","text":"A basic free convection simulation with an AtmosphereModel:\n\nusing Breeze\nusing Oceananigans.Units\nusing CairoMakie\nusing Random: seed!\n\n# Fix the seed to generate the noise, for reproducible simulations.\n# You can try different seeds to explore different noise patterns.\nseed!(42)\n\nNx = Nz = 64\nLz = 4 * 1024\ngrid = RectilinearGrid(size=(Nx, Nz), x=(0, 2Lz), z=(0, Lz), topology=(Periodic, Flat, Bounded))\n\np‚ÇÄ, Œ∏‚ÇÄ = 1e5, 288 # reference state parameters\nreference_state = ReferenceState(grid, base_pressure=p‚ÇÄ, potential_temperature=Œ∏‚ÇÄ)\nformulation = AnelasticFormulation(reference_state)\n\nQ‚ÇÄ = 1000 # heat flux in W / m¬≤\nœÅe_bcs = FieldBoundaryConditions(bottom=FluxBoundaryCondition(Q‚ÇÄ))\nœÅq·µó_bcs = FieldBoundaryConditions(bottom=FluxBoundaryCondition(1e-2))\n\nadvection = WENO()\nmodel = AtmosphereModel(grid; advection, formulation, boundary_conditions = (œÅe=œÅe_bcs, œÅq·µó=œÅq·µó_bcs))\n\nŒîŒ∏ = 2 # ·µíK\nT‚Çõ = reference_state.potential_temperature # K\nŒ∏·µ¢(x, z) = T‚Çõ + ŒîŒ∏ * z / grid.Lz + 2e-2 * ŒîŒ∏ * (rand() - 0.5)\nset!(model, Œ∏=Œ∏·µ¢)\n\nsimulation = Simulation(model, Œît=10, stop_time=2hours)\nconjure_time_step_wizard!(simulation, cfl=0.7)\n\nrun!(simulation)\n\nheatmap(model.temperature, colormap=:thermal)","category":"section"}]
}
