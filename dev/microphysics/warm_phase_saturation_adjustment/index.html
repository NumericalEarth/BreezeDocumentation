<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Warm-phase saturation adjustment ¬∑ Breeze</title><meta name="title" content="Warm-phase saturation adjustment ¬∑ Breeze"/><meta property="og:title" content="Warm-phase saturation adjustment ¬∑ Breeze"/><meta property="twitter:title" content="Warm-phase saturation adjustment ¬∑ Breeze"/><meta name="description" content="Documentation for Breeze."/><meta property="og:description" content="Documentation for Breeze."/><meta property="twitter:description" content="Documentation for Breeze."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Breeze</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../literated/thermal_bubble/">Thermal bubble</a></li><li><a class="tocitem" href="../../literated/cloudy_kelvin_helmholtz/">Cloudy Kelvin-Helmholtz instability</a></li></ul></li><li><a class="tocitem" href="../../thermodynamics/">Thermodynamics</a></li><li><span class="tocitem">Microphysics</span><ul><li><a class="tocitem" href="../microphysics_overview/">Overview</a></li><li class="is-active"><a class="tocitem" href>Warm-phase saturation adjustment</a><ul class="internal"><li><a class="tocitem" href="#Moist-static-energy-and-total-moisture-mass-fraction"><span>Moist static energy and total moisture mass fraction</span></a></li><li><a class="tocitem" href="#Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity"><span>Equilibrium expressions for moist static energy and saturation specific humidity</span></a></li><li><a class="tocitem" href="#The-saturation-adjustment-algorithm"><span>The saturation adjustment algorithm</span></a></li></ul></li><li><a class="tocitem" href="../mixed_phase_saturation_adjustment/">Mixed-phase saturation adjustment</a></li></ul></li><li><span class="tocitem">Developers</span><ul><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">Microphysics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../developer/microphysics_interface/">Microphysics Interface</a></li></ul></li></ul></li><li><a class="tocitem" href="../../dycore_equations_algorithms/">Dycore equations and algorithms</a></li><li><span class="tocitem">Appendix</span><ul><li><a class="tocitem" href="../../appendix/notation/">Notation</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../api/">API</a></li><li><a class="tocitem" href="../../contributing/">Contributors guide</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Microphysics</a></li><li class="is-active"><a href>Warm-phase saturation adjustment</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Warm-phase saturation adjustment</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/NumericalEarth/Breeze.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands">ÔÇõ</span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/NumericalEarth/Breeze.jl/blob/main/docs/src/microphysics/warm_phase_saturation_adjustment.md" title="Edit source on GitHub"><span class="docs-icon fa-solid">ÔÅÑ</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="sec:warm-saturation-adjustment"><a class="docs-heading-anchor" href="#sec:warm-saturation-adjustment">Warm-phase saturation adjustment</a><a id="sec:warm-saturation-adjustment-1"></a><a class="docs-heading-anchor-permalink" href="#sec:warm-saturation-adjustment" title="Permalink"></a></h1><p>Warm-phase saturation adjustment is a model for water droplet nucleation that assumes that water vapor in excess of the saturation specific humidity is instantaneously converted to liquid water. Mixed-phase saturation adjustment is described by <a href="../../references/#Pressel2015">Pressel <em>et al.</em> (2015)</a>.</p><h2 id="Moist-static-energy-and-total-moisture-mass-fraction"><a class="docs-heading-anchor" href="#Moist-static-energy-and-total-moisture-mass-fraction">Moist static energy and total moisture mass fraction</a><a id="Moist-static-energy-and-total-moisture-mass-fraction-1"></a><a class="docs-heading-anchor-permalink" href="#Moist-static-energy-and-total-moisture-mass-fraction" title="Permalink"></a></h2><p>The saturation adjustment solver (specific to our anelastic formulation) takes four inputs:</p><ul><li>moist static energy <span>$e$</span>,</li><li>total moisture mass fraction <span>$q·µó$</span>,</li><li>height <span>$z$</span>, and</li><li>reference pressure <span>$p·µ£$</span>.</li></ul><p>Note that moist static energy density <span>$œÅ·µ£ e$</span> and moisture density <span>$œÅ·µ£ q·µó$</span> are prognostic variables for <a href="../../api/#Breeze.AtmosphereModels.AtmosphereModel-Tuple{Any}"><code>AtmosphereModel</code></a> when using <a href="../../api/#Breeze.AtmosphereModels.AnelasticFormulation"><code>AnelasticFormulation</code></a>, where <span>$œÅ·µ£$</span> is the reference density. With warm-phase microphysics, the moist static energy <span>$e$</span> is related to temperature <span>$T$</span>, height <span>$z$</span>, and liquid mass fraction <span>$qÀ°$</span> by</p><p class="math-container">\[e ‚â° c·µñ·µê \, T + g z - ‚ÑíÀ°·µ£ qÀ° ,\]</p><p>where <span>$c·µñ·µê$</span> is the mixture heat capacity, <span>$g$</span> is gravitational acceleration, and <span>$‚ÑíÀ°·µ£$</span> is the latent heat at the energy reference temperature.</p><h2 id="Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity"><a class="docs-heading-anchor" href="#Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity">Equilibrium expressions for moist static energy and saturation specific humidity</a><a id="Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Equilibrium-expressions-for-moist-static-energy-and-saturation-specific-humidity" title="Permalink"></a></h2><p>Saturation adjustment microphysics assumes that temperature and the moisture mass fractions instantaneously adjust to an equilibrium in which the specific humidity is equal to or less than the saturation specific humidity. This equilibrium condition implies that the liquid mass fraction <span>$qÀ°$</span> is given by</p><p class="math-container">\[qÀ° = \max(0, q·µó - q·µõ‚Å∫)\]</p><p>where <span>$q·µó$</span> is the total moisture mass fraction, and <span>$q·µõ‚Å∫$</span> is the saturation specific humidity at the temperature <span>$T$</span>. The saturation specific humidity is defined as</p><p class="math-container">\[q·µõ‚Å∫ = \frac{œÅ·µõ‚Å∫}{œÅ},\]</p><p>where <span>$œÅ·µõ‚Å∫ = p·µõ‚Å∫ / R·µõ T$</span> is the density associated with the saturation vapor pressure <span>$p·µõ‚Å∫$</span> and <span>$R·µõ$</span> is the vapor gas constant. Note that the air density <span>$œÅ$</span> itself depends on the specific humidity, since according to the ideal gas law,</p><p class="math-container">\[œÅ = \frac{p·µ£}{R·µê T} = \frac{p·µ£}{\left (q·µà R·µà + q·µõ R·µõ \right ) T} ,\]</p><p>where <span>$q·µà = 1 - q·µó$</span> is the dry air mass fraction, <span>$q·µõ$</span> is the specific humidity, <span>$R·µà$</span> is the dry air gas constant, and <span>$R·µõ$</span> is the vapor gas constant. The density <span>$œÅ$</span> is expressed in terms of <span>$p·µ£$</span> under the anelastic approximation.</p><p>In saturated conditions, we have <span>$q·µõ ‚â° q·µõ‚Å∫$</span> by definition, which leads to the expression</p><p class="math-container">\[q·µõ‚Å∫ = \frac{œÅ·µõ‚Å∫}{œÅ} = \frac{R·µê}{R·µõ} \frac{p·µõ‚Å∫}{p·µ£} = \frac{R·µà}{R·µõ} \left ( 1 - q·µó \right ) \frac{p·µõ‚Å∫}{p·µ£} + q·µõ‚Å∫ \frac{p·µõ‚Å∫}{p·µ£} .\]</p><p>Rearranging, we find a new expression for the saturation specific humidity which is <em>valid only in saturated conditions and under the assumptions of saturation adjustment</em>,</p><p class="math-container">\[q·µõ‚Å∫ = \frac{R·µà}{R·µõ} \left ( 1 - q·µó \right ) \frac{p·µõ‚Å∫}{p·µ£ - p·µõ‚Å∫} .\]</p><p>This expression can also be found in paper by <a href="../../references/#Pressel2015">Pressel <em>et al.</em> (2015)</a>, equation (37).</p><h2 id="The-saturation-adjustment-algorithm"><a class="docs-heading-anchor" href="#The-saturation-adjustment-algorithm">The saturation adjustment algorithm</a><a id="The-saturation-adjustment-algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#The-saturation-adjustment-algorithm" title="Permalink"></a></h2><p>We compute the saturation adjustment temperature by solving the nonlinear algebraic equation</p><p class="math-container">\[0 = r(T) ‚â° T - \frac{1}{c·µñ·µê} \left [ e - g z + ‚ÑíÀ°·µ£ \max(0, q·µó - q·µõ‚Å∫) \right ] \,\]</p><p>where <span>$r$</span> is the &quot;residual&quot;, using a secant method.</p><p>As an example, we consider an air parcel at sea level within a reference state with base pressure of 101325 Pa and a surface temperature <span>$T‚ÇÄ = 288$</span>·µíK. We first compute the saturation specific humidity assuming a dry-air density,</p><pre><code class="language-julia hljs">using Breeze
using Breeze.Thermodynamics: saturation_specific_humidity

thermo = ThermodynamicConstants()

p = 101325.0
T = 288.0
R·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)
œÅ = p / (R·µà * T)
q·µõ‚Å∫‚ÇÄ = saturation_specific_humidity(T, œÅ, thermo, thermo.liquid)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.010359995391195264</code></pre><p>Next, we compute the saturation specific humidity for moist air with a carefully chosen moist air mass fraction,</p><pre><code class="language-julia hljs">using Breeze.Microphysics: adjustment_saturation_specific_humidity, WarmPhaseEquilibrium

q·µó = 0.012   # [kg kg‚Åª¬π] total specific humidity
q·µõ‚Å∫ = Breeze.Microphysics.adjustment_saturation_specific_humidity(T, p, q·µó, thermo, WarmPhaseEquilibrium())</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.01040909041114332</code></pre><p>There are two facts of note. First is that we have identified a situation in which <span>$q·µó &gt; q·µõ‚Å∫$</span>, since <span>$q·µó = 0.012$</span> and <span>$q·µõ‚Å∫ = 0.0104$</span>. Second, note that the saturation specific humidity is <em>higher</em> if we assume a saturated state, versus the unsaturated result given by <span>$q·µõ‚Å∫‚ÇÄ$</span> above. This is because moist air is less dense than dry air, so the denominator <span>$œÅ$</span> is smaller under the assumption of a saturated state.</p><p>In equilibrium (and thus under the assumptions of saturation adjustment), the specific humidity is <span>$q·µõ = q·µõ‚Å∫$</span>, while the liquid mass fraction is</p><pre><code class="language-julia hljs">qÀ° = q·µó - q·µõ‚Å∫</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.0015909095888566802</code></pre><p>It is small but greater than zero ‚Üí the typical situation in clouds on Earth. We are now ready to compute moist static energy,</p><pre><code class="language-julia hljs">using Breeze.Thermodynamics: MoistureMassFractions

q = MoistureMassFractions(q·µõ‚Å∫, qÀ°)
c·µñ·µê = mixture_heat_capacity(q, thermo)
g = thermo.gravitational_acceleration
z = 0.0
‚ÑíÀ°·µ£ = thermo.liquid.reference_latent_heat
e = c·µñ·µê * T + g * z - ‚ÑíÀ°·µ£ * qÀ°</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">289449.7954526551</code></pre><p>Moist static energy has units <span>$\mathrm{m^2 / s^2}$</span>, or <span>$\mathrm{J} / \mathrm{kg}$</span>. Next we show that the saturation adjustment solver recovers the input temperature by passing it an &quot;unadjusted&quot; moisture mass fraction into <a href="../../api/#Breeze.Microphysics.compute_temperature-Tuple{Any, SaturationAdjustment, Any}"><code>Breeze.Microphysics.compute_temperature</code></a>,</p><pre><code class="language-julia hljs">using Breeze.Microphysics: compute_temperature

microphysics = SaturationAdjustment(equilibrium=WarmPhaseEquilibrium())

q‚ÇÄ = MoistureMassFractions(q·µó)
ùí∞ = Breeze.Thermodynamics.MoistStaticEnergyState(e, q‚ÇÄ, z, p)
T‚òÖ = compute_temperature(ùí∞, microphysics, thermo)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">288.00001887167366</code></pre><p>Finally, we note that the saturation adjustment solver is initialized with a guess corresponding to the temperature in unsaturated conditions,</p><pre><code class="language-julia hljs">c·µñ·µê‚ÇÅ = mixture_heat_capacity(q‚ÇÄ, thermo)
T‚ÇÅ = (e - g * z) / c·µñ·µê‚ÇÅ</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">285.13288359502644</code></pre><p>The difference between <span>$T‚ÇÅ$</span> and the solution <span>$T_\mathrm{eq}$</span> is <span>$T_\mathrm{eq} - T‚ÇÅ = ‚ÑíÀ°·µ£ qÀ° / c·µñ·µê$</span> and is therefore strictly positive. In other words, <span>$T‚ÇÅ$</span> represents a lower bound.</p><p>To generate a second guess for the secant solver, we start by estimating the liquid mass fraction using the guess <span>$T = T‚ÇÅ$</span>,</p><pre><code class="language-julia hljs">q·µõ‚Å∫‚ÇÇ = adjustment_saturation_specific_humidity(T‚ÇÅ, p, q·µó, thermo, WarmPhaseEquilibrium())
qÀ°‚ÇÅ = q·µó - q·µõ‚Å∫‚ÇÇ</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">0.00338954186544636</code></pre><p>In general, this represents an <em>overestimate</em> of the liquid mass fraction, because <span>$q·µõ‚Å∫‚ÇÇ$</span> is underestimated by the too-low temperature <span>$T‚ÇÅ$</span>. We thus increment the first guess by half of the difference implied by the estimate <span>$qÀ°‚ÇÅ$</span>,</p><pre><code class="language-julia hljs">q‚ÇÇ = MoistureMassFractions(q·µõ‚Å∫‚ÇÇ, qÀ°‚ÇÅ)
c·µñ·µê‚ÇÇ = mixture_heat_capacity(q‚ÇÇ, thermo)
ŒîT = ‚ÑíÀ°·µ£ * qÀ°‚ÇÅ / c·µñ·µê‚ÇÇ
T‚ÇÇ = T‚ÇÅ + ŒîT / 2</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">289.27571174858616</code></pre><p>The residual looks like</p><pre><code class="language-julia hljs">using Breeze.Microphysics: saturation_adjustment_residual
using CairoMakie

equilibrium = WarmPhaseEquilibrium()
T = 230:0.5:320
r = [saturation_adjustment_residual(T ≤, ùí∞, thermo, equilibrium) for T ≤ in T]
q·µõ‚Å∫ = [adjustment_saturation_specific_humidity(T ≤, p, q·µó, thermo, equilibrium) for T ≤ in T]

fig = Figure()
axr = Axis(fig[1, 1], xlabel=&quot;Temperature (K)&quot;, ylabel=&quot;Saturation adjustment residual (K)&quot;)
axq = Axis(fig[2, 1], xlabel=&quot;Temperature (K)&quot;, ylabel=&quot;Estimated liquid fraction&quot;)
lines!(axr, T, r)
scatter!(axr, 288, 0, marker=:star5, markersize=30, color=:tomato)

lines!(axq, T, max.(0, q·µó .- q·µõ‚Å∫))

fig</code></pre><img src="82a98bd6.svg" alt="Example block output"/><p>There is a kink at the temperature wherein the estimated liquid mass fraction bottoms out.</p><h3 id="Equilibrium-states-with-varying-total-specific-humidity"><a class="docs-heading-anchor" href="#Equilibrium-states-with-varying-total-specific-humidity">Equilibrium states with varying total specific humidity</a><a id="Equilibrium-states-with-varying-total-specific-humidity-1"></a><a class="docs-heading-anchor-permalink" href="#Equilibrium-states-with-varying-total-specific-humidity" title="Permalink"></a></h3><p>As a second example, we examine the dependence of temperature on total specific humidity when the moist static energy is held fixed.</p><pre><code class="language-julia hljs">using Breeze.Thermodynamics: MoistStaticEnergyState

T‚ÇÄ = 288
c·µñ·µà = thermo.dry_air.heat_capacity
e‚ÇÄ = c·µñ·µà * T‚ÇÄ # representative value
z = 0.0
p = 101325.0

# Vary the total moisture mass fraction:
q·µó = 0:1e-4:0.035 # [kg kg‚Åª¬π]

T = zeros(length(q·µó))
qÀ° = zeros(length(q·µó))

for (i, q·µó‚Å±) in enumerate(q·µó)
    q = MoistureMassFractions(q·µó‚Å±)
    ùí∞ = MoistStaticEnergyState(e‚ÇÄ, q, z, p)
    T[i] = compute_temperature(ùí∞, microphysics, thermo)
    q·µõ‚Å∫ = Breeze.Microphysics.adjustment_saturation_specific_humidity(T[i], p, q·µó‚Å±, thermo, WarmPhaseEquilibrium())
    qÀ°[i] = max(0, q·µó‚Å± - q·µõ‚Å∫)
end

using CairoMakie

# Hard code the transition index here, e.g. 105 (adjust to your needs)
transition_idx = 105

fig = Figure()
axT = Axis(fig[1, 1], xlabel=&quot;Total specific humidity (kg kg‚Åª¬π)&quot;, ylabel=&quot;Temperature (·µíK)&quot;)
axq = Axis(fig[2, 1], xlabel=&quot;Total specific humidity (kg kg‚Åª¬π)&quot;, ylabel=&quot;Liquid mass fraction&quot;)

lines!(axT, q·µó, T)
lines!(axq, q·µó, qÀ°)

idx = searchsortedfirst(qÀ°, 1e-4)
vlines!(axT, q·µó[idx], color=:gray, linestyle=:dash, linewidth=2)
vlines!(axq, q·µó[idx], color=:gray, linestyle=:dash, linewidth=2)

text!(axq, &quot;unsaturated, clear&quot;, position=(q·µó[idx-5], 4e-3), align=(:right, :top))
text!(axq, &quot;saturated and cloudy ‚Üí&quot;, position=(q·µó[idx+5], 8e-3), align=(:left, :top))

fig</code></pre><img src="4424717c.svg" alt="Example block output"/><h3 id="Saturation-adjustment-with-varying-height"><a class="docs-heading-anchor" href="#Saturation-adjustment-with-varying-height">Saturation adjustment with varying height</a><a id="Saturation-adjustment-with-varying-height-1"></a><a class="docs-heading-anchor-permalink" href="#Saturation-adjustment-with-varying-height" title="Permalink"></a></h3><p>For a third example, we consider a state with constant moist static energy and total specific humidity (equivalently, a constant <span>$Œ∏$</span> in this reference state), but at varying heights:</p><pre><code class="language-julia hljs">using Breeze

grid = RectilinearGrid(size=100, z=(0, 1e4), topology=(Flat, Flat, Bounded))
thermo = ThermodynamicConstants()

Œ∏‚ÇÄ = 288
p‚ÇÄ = 101325
reference_state = ReferenceState(grid, thermo;
                                 base_pressure = p‚ÇÄ,
                                 potential_temperature = Œ∏‚ÇÄ)

q·µó = 0.005
q = MoistureMassFractions(q·µó)

z = znodes(grid, Center())
T = zeros(grid.Nz)
q·µõ‚Å∫ = zeros(grid.Nz)
qÀ° = zeros(grid.Nz)
rh = zeros(grid.Nz)

# Set a constant moist static energy referenced to z = 0, clear air
c·µñ·µê = mixture_heat_capacity(q, thermo)
R·µà = Breeze.Thermodynamics.dry_air_gas_constant(thermo)
g = thermo.gravitational_acceleration

for k = 1:grid.Nz
    p·µ£ = reference_state.pressure[1, 1, k]
    T·µ£ = Œ∏‚ÇÄ * (p·µ£ / p‚ÇÄ)^(R·µà / c·µñ·µà)
    e‚ÇÄ = c·µñ·µê * T·µ£ + g * z[k]
    ùí∞ = MoistStaticEnergyState(e‚ÇÄ, q, z[k], p·µ£)
    T[k] = compute_temperature(ùí∞, microphysics, thermo)

    # Saturation specific humidity via adjustment formula using T[k], p·µ£, and q·µó
    q·µõ‚Å∫[k] = Breeze.Microphysics.adjustment_saturation_specific_humidity(T[k], p·µ£, q·µó, thermo, WarmPhaseEquilibrium())
    qÀ°[k] = max(0, q·µó - q·µõ‚Å∫[k])
    rh[k] = 100 * min(q·µó, q·µõ‚Å∫[k]) / q·µõ‚Å∫[k]
end

c·µñ·µà = thermo.dry_air.heat_capacity
g = thermo.gravitational_acceleration

fig = Figure(size=(700, 350))

yticks = 0:2e3:10e3

axT = Axis(fig[1, 1:2]; xlabel = &quot;Temperature (·µíK)&quot;, ylabel = &quot;Height (m)&quot;, yticks)
axq‚Å∫ = Axis(fig[1, 3]; xlabel = &quot;Saturation\n specific humidity\n (kg kg‚Åª¬π)&quot;,
                       yticks, yticklabelsvisible = false)
axqÀ° = Axis(fig[1, 4]; xlabel = &quot;Liquid\n specific humidity\n (kg kg‚Åª¬π)&quot;,
                       yticks, yticklabelsvisible = false)

axrh = Axis(fig[1, 5]; xlabel = &quot;Relative\n humidity (%)&quot;,
                       xticks = 0:20:100,
                       yticks, yticklabelsvisible = false)

lines!(axT, T, z)
lines!(axT, T[1] .- g * z / c·µñ·µà, z, linestyle = :dash, color = :orange, linewidth = 2)
lines!(axq‚Å∫, q·µõ‚Å∫, z)
lines!(axqÀ°, qÀ°, z)
lines!(axrh, rh, z)

fig</code></pre><img src="455845a8.svg" alt="Example block output"/></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../microphysics_overview/">¬´ Overview</a><a class="docs-footer-nextpage" href="../mixed_phase_saturation_adjustment/">Mixed-phase saturation adjustment ¬ª</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Thursday 27 November 2025 05:21">Thursday 27 November 2025</span>. Using Julia version 1.12.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
